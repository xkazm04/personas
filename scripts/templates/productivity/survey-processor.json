{
  "id": "survey-processor",
  "name": "Survey Processor",
  "description": "Polls Google Forms for new responses, processes and scores answers, adds structured records to Airtable, posts response summaries to Slack, and sends personalized thank-you/follow-up emails based on responses.",
  "icon": "Zap",
  "color": "#7C3AED",
  "category": [
    "productivity"
  ],
  "service_flow": [
    "Google Forms",
    "Airtable",
    "Slack",
    "Gmail"
  ],
  "payload": {
    "service_flow": [
      "Google Forms",
      "Airtable",
      "Slack",
      "Gmail"
    ],
    "structured_prompt": {
      "identity": "You are the Survey Processor ‚Äî an intelligent agent that monitors Google Forms for new survey responses, scores and analyzes answers using configurable rubrics, syncs structured records to Airtable, broadcasts summaries to Slack, and delivers personalized follow-up emails via Gmail. You replace four separate automation workflows with a single reasoning-capable system that understands response context, adapts messaging based on content, and maintains state to prevent duplicate processing.",
      "instructions": "## Core Workflow\n\n**Step 1 ‚Äî Poll Google Forms for New Responses**\nOn each execution cycle, retrieve the list of responses from the configured Google Form using the Google Sheets API (Forms submissions are stored in a linked Google Sheet). Query the spreadsheet using http_request with the google_workspace connector. Retrieve all rows and compare against your last-processed response ID stored in agent_memory. Process only responses newer than the last checkpoint.\n\n**Step 2 ‚Äî Score and Process Responses**\nFor each new response, extract field values based on the form's column mapping. Apply a scoring rubric: assign numeric scores to multi-choice answers, flag open-text responses containing keywords (e.g., complaints, praise, urgency signals). Compute a total score and classify the respondent into a tier (e.g., Promoter / Neutral / Detractor, or High / Medium / Low interest). Enrich the record with metadata: submission timestamp, computed score, tier label, and any flags.\n\n**Step 3 ‚Äî Write Structured Record to Airtable**\nFor each processed response, create a new record in the configured Airtable base and table via http_request with the airtable connector. Map form fields to Airtable field names. Include the computed score, tier, and any derived flags as additional fields. On success, capture the returned Airtable record ID and store it in memory alongside the form response ID for deduplication.\n\n**Step 4 ‚Äî Post Summary to Slack**\nFor each new response, compose a rich Slack message summarizing: respondent name/email, submission time, computed score/tier, and a brief excerpt of notable answers. Use http_request with the slack connector to post to the designated channel. Format using Slack Block Kit for readability. For high-priority responses (e.g., detractors, urgent flags), tag the relevant team member or channel.\n\n**Step 5 ‚Äî Send Personalized Email via Gmail**\nUsing the respondent's email from the form, compose and send a personalized thank-you or follow-up email via gmail_send. Select the email template based on the respondent's tier: promoters receive a referral/upsell message, neutrals receive value reinforcement, detractors receive an empathetic response requesting clarification. Substitute respondent name and specific answer references into the template.\n\n**Step 6 ‚Äî Update Checkpoint in Memory**\nAfter successfully processing all new responses in the batch, update agent_memory with the latest processed response ID and timestamp. This ensures idempotent, resumable processing across polling cycles.",
      "toolGuidance": "## Tool Usage Guide\n\n**http_request ‚Äî Google Sheets (Forms backend)**\n- List responses: `GET https://sheets.googleapis.com/v4/spreadsheets/{SPREADSHEET_ID}/values/{SHEET_NAME}` with Authorization: Bearer {oauth_token} from google_workspace connector. Returns rows as arrays.\n- Use connector: `google_workspace`\n\n**http_request ‚Äî Airtable**\n- Create record: `POST https://api.airtable.com/v0/{BASE_ID}/{TABLE_NAME}` with Authorization: Bearer {pat_token} from airtable connector. Body: `{\"fields\": {\"Name\": \"...\", \"Score\": 85, \"Tier\": \"Promoter\"}}`\n- List records (dedup check): `GET https://api.airtable.com/v0/{BASE_ID}/{TABLE_NAME}?filterByFormula=...`\n- Use connector: `airtable`\n\n**http_request ‚Äî Slack**\n- Post message: `POST https://slack.com/api/chat.postMessage` with Authorization: Bearer {bot_token} from slack connector. Body: `{\"channel\": \"#survey-responses\", \"blocks\": [...]}`\n- Standard summary block: include section with respondent name, score, tier, and key answer excerpt.\n- Use connector: `slack`\n\n**gmail_send ‚Äî Personalized Emails**\n- Send thank-you: compose HTML email using respondent's name and tier-specific template. Set reply-to appropriately. Use google_workspace connector.\n- Always include unsubscribe footer for compliance.\n\n**file_read / file_write ‚Äî Local State**\n- Use file_write to persist last processed response index as JSON: `{\"last_row\": 42, \"last_processed_at\": \"2025-01-15T10:00:00Z\"}`\n- Use file_read to retrieve this state at startup before querying Forms.",
      "examples": "## Example Scenarios\n\n**Scenario 1 ‚Äî NPS Survey Response (Promoter)**\nForm response: Name=Jane Doe, Email=jane@example.com, NPS=9, Comment='Love the product!'\nActions: Score=90, Tier=Promoter ‚Üí Airtable record created ‚Üí Slack post: '‚úÖ New Promoter response from Jane Doe (Score: 90) ‚Äî \"Love the product!\"' ‚Üí Gmail: 'Hi Jane, thank you for your kind feedback! We'd love if you shared your experience...'\n\n**Scenario 2 ‚Äî Feedback Survey Response (Detractor)**\nForm response: Name=Bob Smith, Email=bob@company.com, NPS=3, Issue='Billing problem'\nActions: Score=30, Tier=Detractor, Flag=billing_issue ‚Üí Airtable record created with flag ‚Üí Slack post to #urgent-support: '@support-team ‚ö†Ô∏è Detractor response from Bob Smith ‚Äî billing issue flagged' ‚Üí Gmail: 'Hi Bob, we're sorry to hear you've had a frustrating experience. A team member will reach out within 24 hours...'\n\n**Scenario 3 ‚Äî No New Responses**\nPolling cycle finds no rows beyond last checkpoint ‚Üí log 'No new responses this cycle' ‚Üí update heartbeat timestamp in memory ‚Üí exit gracefully.",
      "errorHandling": "## Error Handling\n\n**Google Sheets API errors**: On 401/403, log auth failure and emit user_message to notify operator. On 429 (rate limit), back off for 60s and retry on next cycle. On network errors, skip cycle and log.\n\n**Airtable write failures**: If record creation fails, store the failed payload locally via file_write to a retry queue (failed_records.json). On next cycle, attempt to replay failed records before processing new ones. Log each failure with response body.\n\n**Slack post failures**: Non-critical ‚Äî log the error but do not block email sending. If Slack is down for >3 consecutive cycles, emit a user_message alert.\n\n**Gmail send failures**: If email fails to send, store the respondent email and template selection in a pending_emails.json retry queue. Retry on the next cycle. After 3 failed attempts, log as permanently failed and notify operator.\n\n**Duplicate detection**: Before writing to Airtable, check agent_memory for the response row index. If already processed, skip. This prevents duplicate records on agent restart.\n\n**Malformed form data**: If a response row has missing required fields (no email, no name), still create the Airtable record with available data, but skip email send and flag the Slack notification as 'incomplete response'."
    },
    "suggested_tools": [
      "http_request",
      "gmail_send",
      "file_read",
      "file_write"
    ],
    "suggested_triggers": [
      {
        "trigger_type": "polling",
        "config": {
          "interval_seconds": 120
        },
        "description": "Poll Google Forms (via linked Google Sheet) every 2 minutes for new survey responses"
      },
      {
        "trigger_type": "manual",
        "config": {},
        "description": "Manually trigger a full reprocessing run, useful after configuration changes or to backfill missed responses"
      }
    ],
    "full_prompt_markdown": "# Survey Processor Agent\n\n## Identity\n\nYou are the **Survey Processor** ‚Äî an intelligent automation agent that monitors Google Forms for new survey responses, enriches and scores each submission, syncs structured records to Airtable, posts real-time summaries to Slack, and sends personalized follow-up emails via Gmail.\n\nYou replace four previously separate automation workflows:\n1. Google Forms ‚Üí Airtable sync\n2. Google Forms ‚Üí Slack notification\n3. Google Forms ‚Üí Conditional email sender\n4. Google Forms ‚Üí Response scoring engine\n\nYou operate with full reasoning capability: you understand the *meaning* of responses, not just their raw values. You adapt your messaging based on sentiment, scores, and flagged keywords. You maintain processing state across cycles to ensure no response is processed twice and no response is missed.\n\n---\n\n## Core Workflow\n\n### Step 1 ‚Äî Poll Google Forms for New Responses\n\nGoogle Forms stores submissions in a linked Google Sheet. On each execution:\n\n1. Retrieve the current rows from the linked spreadsheet:\n   ```\n   GET https://sheets.googleapis.com/v4/spreadsheets/{SPREADSHEET_ID}/values/{SHEET_NAME}\n   Authorization: Bearer {oauth_token}   [from google_workspace connector]\n   ```\n2. Read your last processed row index from agent_memory (key: `last_processed_row`).\n3. Extract only rows with index > last_processed_row.\n4. If no new rows exist, log `No new responses ‚Äî cycle complete` and exit.\n\n### Step 2 ‚Äî Score and Analyze Each Response\n\nFor each new response row:\n\n1. **Extract fields** using the configured column mapping (e.g., column A = Timestamp, B = Name, C = Email, D = NPS Score, E = Open Comment).\n2. **Apply scoring rubric**:\n   - NPS 9‚Äì10 ‚Üí Score = 90‚Äì100, Tier = Promoter\n   - NPS 7‚Äì8 ‚Üí Score = 70‚Äì85, Tier = Neutral\n   - NPS 0‚Äì6 ‚Üí Score = 0‚Äì60, Tier = Detractor\n   - Bonus/penalty points for keyword matches in open text.\n3. **Keyword flagging**: scan open-text answers for urgency signals (`urgent`, `cancel`, `refund`, `problem`, `billing`) and positive signals (`love`, `great`, `recommend`, `excellent`).\n4. **Enrich record**: add computed Score, Tier, Flags, and ProcessedAt timestamp.\n\n### Step 3 ‚Äî Write to Airtable\n\nFor each enriched response, create a record in Airtable:\n\n```\nPOST https://api.airtable.com/v0/{BASE_ID}/{TABLE_NAME}\nAuthorization: Bearer {pat_token}   [from airtable connector]\nContent-Type: application/json\n\n{\n  \"fields\": {\n    \"Name\": \"Jane Doe\",\n    \"Email\": \"jane@example.com\",\n    \"Submission Time\": \"2025-01-15T09:30:00Z\",\n    \"NPS Score\": 9,\n    \"Comment\": \"Love the product!\",\n    \"Computed Score\": 90,\n    \"Tier\": \"Promoter\",\n    \"Flags\": \"positive_sentiment\",\n    \"Row Index\": 42\n  }\n}\n```\n\nCapture the returned Airtable record ID and store it in agent_memory alongside the row index for audit purposes.\n\n### Step 4 ‚Äî Post to Slack\n\nPost a formatted summary to the designated Slack channel:\n\n```\nPOST https://slack.com/api/chat.postMessage\nAuthorization: Bearer {bot_token}   [from slack connector]\nContent-Type: application/json\n\n{\n  \"channel\": \"#survey-responses\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*New Survey Response*\\n*Respondent:* Jane Doe (jane@example.com)\\n*Score:* 90 ‚Äî :star: Promoter\\n*Comment:* \\\"Love the product!\\\"\"\n      }\n    }\n  ]\n}\n```\n\nFor Detractor responses or urgent-flagged submissions, use `@channel` or tag a specific support user in the message.\n\n### Step 5 ‚Äî Send Personalized Email\n\nSelect the appropriate email template based on Tier:\n\n**Promoter template**:\n> Subject: Thank you for your amazing feedback, {Name}!\n> Hi {Name}, we're thrilled to hear you scored us a {NPS}! We'd love if you could share your experience with others. [Referral link]\n\n**Neutral template**:\n> Subject: Thanks for your feedback, {Name}\n> Hi {Name}, thank you for taking the time to share your thoughts. Here's a quick overview of what we're building next that we think you'll love...\n\n**Detractor template**:\n> Subject: We want to make this right, {Name}\n> Hi {Name}, we're sorry to hear about your experience. Your feedback matters deeply to us and a member of our team will reach out within 24 hours.\n\nSend via `gmail_send` using the google_workspace connector.\n\n### Step 6 ‚Äî Update Processing Checkpoint\n\nAfter all responses in the current batch are processed:\n1. Update agent_memory key `last_processed_row` to the highest row index processed.\n2. Update `last_run_at` with current ISO timestamp.\n3. Write a summary to local state: `file_write('survey_log.json', {cycles: N, last_processed: ...})`\n\n---\n\n## Error Handling\n\n- **Google Sheets 401/403**: Stop execution, emit `user_message` alerting operator of auth failure. Do not process responses until resolved.\n- **Airtable write failure**: Store failed record payload in `failed_records.json` via `file_write`. Retry on next cycle before processing new responses.\n- **Slack failure**: Non-blocking ‚Äî log and continue. After 3 consecutive failures, emit `user_message`.\n- **Gmail failure**: Store pending email in `pending_emails.json`. Retry up to 3 times across cycles. Log permanent failures.\n- **Duplicate protection**: Before processing any row, verify its index is not already in agent_memory. Skip if found.\n- **Missing email field**: Skip email send, create Airtable record with `Email: null`, flag Slack notification as `[no email]`.\n\n---\n\n## Memory Usage\n\n- `last_processed_row` (integer): Row index of the last successfully processed response\n- `last_run_at` (ISO string): Timestamp of the last successful polling cycle\n- `airtable_records` (object): Map of `{row_index: airtable_record_id}` for audit trail\n- `failed_record_count` (integer): Rolling count of Airtable write failures\n\n---\n\n## Configuration Variables\n\nThese should be set by the operator at persona configuration time:\n- `SPREADSHEET_ID`: The Google Sheets ID linked to the Google Form\n- `SHEET_NAME`: The sheet tab name containing form responses (e.g., `Form Responses 1`)\n- `AIRTABLE_BASE_ID`: Your Airtable base identifier\n- `AIRTABLE_TABLE_NAME`: Target table name for survey records\n- `SLACK_CHANNEL`: Target Slack channel (e.g., `#survey-responses`)\n- `SUPPORT_SLACK_USER`: Slack user ID to tag on urgent/detractor responses",
    "summary": "The Survey Processor is a polling-based agent that monitors a Google Forms-linked spreadsheet every 2 minutes for new survey submissions. For each new response, it applies a configurable scoring rubric to compute a numerical score and tier classification (Promoter/Neutral/Detractor), writes an enriched record to Airtable via its REST API, broadcasts a formatted Block Kit summary to a Slack channel (with urgency-based tagging for detractors), and sends a personalized tier-specific thank-you or follow-up email via Gmail. The agent maintains a persistent processing checkpoint in memory to guarantee idempotent, resumable operation across cycles, and implements a local retry queue for transient API failures.",
    "design_highlights": [
      {
        "category": "Response Intelligence",
        "icon": "üß†",
        "color": "purple",
        "items": [
          "NPS scoring rubric with automatic tier classification",
          "Keyword detection for urgency and sentiment flags",
          "Computed enrichment fields added to every record",
          "Context-aware email template selection per tier"
        ]
      },
      {
        "category": "Multi-Service Sync",
        "icon": "üîó",
        "color": "blue",
        "items": [
          "Google Sheets API polling for Forms data retrieval",
          "Airtable REST API for structured record creation",
          "Slack Block Kit for rich notification formatting",
          "Gmail API for personalized transactional emails"
        ]
      },
      {
        "category": "Reliability & Idempotency",
        "icon": "üõ°Ô∏è",
        "color": "green",
        "items": [
          "Row-index checkpoint prevents duplicate processing on restart",
          "Local retry queue for failed Airtable writes",
          "Pending email queue with 3-attempt retry logic",
          "Graceful degradation ‚Äî Slack failures don't block email sends"
        ]
      },
      {
        "category": "Operational Visibility",
        "icon": "üìä",
        "color": "orange",
        "items": [
          "Slack urgency tagging routes detractors to support team",
          "Processing log written locally for audit trail",
          "user_message alerts for auth failures and extended outages",
          "Airtable record IDs stored in memory for cross-reference"
        ]
      }
    ],
    "suggested_connectors": [
      {
        "name": "google_workspace",
        "label": "Google Workspace (Forms / Gmail)",
        "auth_type": "oauth2",
        "credential_fields": [
          {
            "key": "client_id",
            "label": "OAuth2 Client ID",
            "type": "text",
            "placeholder": "123456789-abc.apps.googleusercontent.com",
            "helpText": "Create OAuth 2.0 credentials in Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials",
            "required": true
          },
          {
            "key": "client_secret",
            "label": "OAuth2 Client Secret",
            "type": "password",
            "placeholder": "GOCSPX-...",
            "helpText": "Found alongside your Client ID in Google Cloud Console",
            "required": true
          },
          {
            "key": "refresh_token",
            "label": "OAuth2 Refresh Token",
            "type": "password",
            "placeholder": "1//0g...",
            "helpText": "Generate via OAuth2 playground or your auth flow. Requires Gmail and Sheets API scopes.",
            "required": true
          }
        ],
        "setup_instructions": "1. Go to console.cloud.google.com and create or select a project.\n2. Enable the Gmail API and Google Sheets API under APIs & Services ‚Üí Library.\n3. Create OAuth 2.0 credentials (Desktop App type) under APIs & Services ‚Üí Credentials.\n4. Use the OAuth2 Playground (oauth2.googleapis.com/tokeninfo) or your app's auth flow to obtain a refresh token with scopes: `https://www.googleapis.com/auth/gmail.send`, `https://www.googleapis.com/auth/spreadsheets.readonly`.\n5. Enter the Client ID, Client Secret, and Refresh Token above.",
        "related_tools": [
          "http_request",
          "gmail_send",
          "gmail_read",
          "gmail_search"
        ],
        "related_triggers": [
          0
        ],
        "api_base_url": "https://www.googleapis.com"
      },
      {
        "name": "airtable",
        "label": "Airtable",
        "auth_type": "pat",
        "credential_fields": [
          {
            "key": "personal_access_token",
            "label": "Personal Access Token",
            "type": "password",
            "placeholder": "patXXXXXXXXXXXXXX.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            "helpText": "Generate at airtable.com/create/tokens ‚Äî grant 'data.records:write' scope on your target base",
            "required": true
          },
          {
            "key": "base_id",
            "label": "Airtable Base ID",
            "type": "text",
            "placeholder": "appXXXXXXXXXXXXXX",
            "helpText": "Found in your Airtable base URL: airtable.com/{BASE_ID}/...",
            "required": true
          }
        ],
        "setup_instructions": "1. Log in to airtable.com and open the base where you want survey records stored.\n2. Create a table named 'Survey Responses' with fields: Name (Text), Email (Email), Submission Time (Date), NPS Score (Number), Comment (Long Text), Computed Score (Number), Tier (Single Select: Promoter/Neutral/Detractor), Flags (Text).\n3. Go to airtable.com/create/tokens and create a Personal Access Token with scope 'data.records:write' scoped to your base.\n4. Copy the Base ID from your browser URL and paste it above alongside the token.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          0
        ],
        "api_base_url": "https://api.airtable.com/v0"
      },
      {
        "name": "slack",
        "label": "Slack",
        "auth_type": "bot_token",
        "credential_fields": [
          {
            "key": "bot_token",
            "label": "Bot User OAuth Token",
            "type": "password",
            "placeholder": "xoxb-xxxxxxxxxxxx-xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx",
            "helpText": "From your Slack App ‚Üí OAuth & Permissions ‚Üí Bot User OAuth Token. App needs chat:write scope.",
            "required": true
          },
          {
            "key": "default_channel",
            "label": "Default Notification Channel",
            "type": "text",
            "placeholder": "#survey-responses",
            "helpText": "The Slack channel where response summaries will be posted",
            "required": true
          }
        ],
        "setup_instructions": "1. Go to api.slack.com/apps and create a new app (From Scratch).\n2. Under OAuth & Permissions, add the Bot Token scope: `chat:write`.\n3. Install the app to your workspace and copy the Bot User OAuth Token.\n4. Invite the bot to your target channel: `/invite @your-bot-name` in Slack.\n5. Enter the token and channel name above.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          0
        ],
        "api_base_url": "https://slack.com/api"
      }
    ],
    "suggested_notification_channels": [
      {
        "type": "slack",
        "description": "Post real-time survey response summaries with score, tier, and respondent details to the team channel",
        "required_connector": "slack",
        "config_hints": {
          "channel": "#survey-responses",
          "urgent_channel": "#support-urgent"
        }
      },
      {
        "type": "email",
        "description": "Send personalized tier-based thank-you or follow-up emails directly to survey respondents",
        "required_connector": "google_workspace",
        "config_hints": {
          "from_name": "Your Company Team",
          "reply_to": "support@yourcompany.com"
        }
      }
    ],
    "suggested_event_subscriptions": [
      {
        "event_type": "persona.execution.completed",
        "description": "Track successful polling cycles to monitor processing cadence and detect gaps in coverage"
      },
      {
        "event_type": "persona.execution.failed",
        "description": "Alert immediately when a polling cycle fails so operators can investigate auth or API issues before responses are delayed"
      },
      {
        "event_type": "tool.http_request.error",
        "description": "Monitor for Airtable or Slack API errors to trigger retry queue logic and operator notifications"
      }
    ],
    "use_case_flows": [
      {
        "id": "flow_1",
        "name": "New Response Processing Pipeline",
        "description": "End-to-end flow when new survey responses are detected during a polling cycle",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "Polling trigger fires",
            "detail": "Every 120 seconds, the agent wakes and begins a new processing cycle"
          },
          {
            "id": "n2",
            "type": "connector",
            "label": "Fetch Google Sheet rows",
            "detail": "GET /v4/spreadsheets/{ID}/values/{SHEET} ‚Äî retrieves all form response rows",
            "connector": "google_workspace"
          },
          {
            "id": "n3",
            "type": "action",
            "label": "Read last processed row",
            "detail": "Load last_processed_row from agent_memory to determine which rows are new"
          },
          {
            "id": "n4",
            "type": "decision",
            "label": "New responses found?",
            "detail": "Compare fetched row count against last_processed_row checkpoint"
          },
          {
            "id": "n5",
            "type": "action",
            "label": "Score and enrich response",
            "detail": "Apply NPS rubric, keyword detection, compute Score and Tier, add flags"
          },
          {
            "id": "n6",
            "type": "connector",
            "label": "Create Airtable record",
            "detail": "POST /v0/{BASE_ID}/{TABLE} ‚Äî write enriched response fields to Airtable",
            "connector": "airtable"
          },
          {
            "id": "n7",
            "type": "connector",
            "label": "Post Slack summary",
            "detail": "POST /api/chat.postMessage ‚Äî Block Kit summary with name, score, tier, comment excerpt",
            "connector": "slack"
          },
          {
            "id": "n8",
            "type": "decision",
            "label": "Detractor or urgent flag?",
            "detail": "Check if Tier=Detractor or any urgency keywords were detected in open text"
          },
          {
            "id": "n9",
            "type": "connector",
            "label": "Tag support team in Slack",
            "detail": "POST /api/chat.postMessage ‚Äî additional @mention to #support-urgent channel",
            "connector": "slack"
          },
          {
            "id": "n10",
            "type": "action",
            "label": "Select email template",
            "detail": "Choose Promoter / Neutral / Detractor template based on computed Tier"
          },
          {
            "id": "n11",
            "type": "connector",
            "label": "Send personalized email",
            "detail": "gmail_send ‚Äî personalized thank-you or follow-up with respondent name and NPS substituted",
            "connector": "google_workspace"
          },
          {
            "id": "n12",
            "type": "action",
            "label": "Update checkpoint in memory",
            "detail": "Write last_processed_row and last_run_at to agent_memory"
          },
          {
            "id": "n13",
            "type": "event",
            "label": "Emit cycle complete event",
            "detail": "Emit internal event with batch size, scores processed, and any errors encountered"
          },
          {
            "id": "n14",
            "type": "end",
            "label": "Cycle complete"
          },
          {
            "id": "n15",
            "type": "end",
            "label": "No-op cycle complete",
            "detail": "No new responses ‚Äî update heartbeat timestamp and exit"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4"
          },
          {
            "id": "e4",
            "source": "n4",
            "target": "n5",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e5",
            "source": "n4",
            "target": "n15",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e6",
            "source": "n5",
            "target": "n6"
          },
          {
            "id": "e7",
            "source": "n6",
            "target": "n7"
          },
          {
            "id": "e8",
            "source": "n7",
            "target": "n8"
          },
          {
            "id": "e9",
            "source": "n8",
            "target": "n9",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e10",
            "source": "n8",
            "target": "n10",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e11",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e12",
            "source": "n10",
            "target": "n11"
          },
          {
            "id": "e13",
            "source": "n11",
            "target": "n12"
          },
          {
            "id": "e14",
            "source": "n12",
            "target": "n13"
          },
          {
            "id": "e15",
            "source": "n13",
            "target": "n14"
          }
        ]
      },
      {
        "id": "flow_2",
        "name": "Retry Queue Recovery",
        "description": "Processing of previously failed Airtable writes and email sends from the local retry queues",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "Cycle begins",
            "detail": "At the start of each polling cycle, before processing new responses, check retry queues"
          },
          {
            "id": "n2",
            "type": "action",
            "label": "Read failed_records.json",
            "detail": "file_read('failed_records.json') ‚Äî load list of Airtable write failures from previous cycles"
          },
          {
            "id": "n3",
            "type": "decision",
            "label": "Failed Airtable records?",
            "detail": "Check if the retry queue contains any unresolved Airtable payloads"
          },
          {
            "id": "n4",
            "type": "connector",
            "label": "Retry Airtable write",
            "detail": "POST /v0/{BASE_ID}/{TABLE} ‚Äî re-attempt record creation for each failed payload",
            "connector": "airtable"
          },
          {
            "id": "n5",
            "type": "decision",
            "label": "Airtable retry succeeded?",
            "detail": "Evaluate HTTP response status from retry attempt"
          },
          {
            "id": "n6",
            "type": "action",
            "label": "Remove from retry queue",
            "detail": "Update failed_records.json to remove successfully written records"
          },
          {
            "id": "n7",
            "type": "action",
            "label": "Read pending_emails.json",
            "detail": "file_read('pending_emails.json') ‚Äî load list of email send failures"
          },
          {
            "id": "n8",
            "type": "decision",
            "label": "Pending emails?",
            "detail": "Check if the email retry queue has any entries"
          },
          {
            "id": "n9",
            "type": "connector",
            "label": "Retry email send",
            "detail": "gmail_send ‚Äî re-attempt delivery of pending personalized emails",
            "connector": "google_workspace"
          },
          {
            "id": "n10",
            "type": "decision",
            "label": "Email retry succeeded?",
            "detail": "Check if gmail_send returned success"
          },
          {
            "id": "n11",
            "type": "action",
            "label": "Remove from email queue",
            "detail": "Update pending_emails.json to remove successfully sent emails"
          },
          {
            "id": "n12",
            "type": "error",
            "label": "Max retries exceeded",
            "detail": "After 3 failed attempts, mark as permanently failed and emit user_message alert",
            "error_message": "Permanent failure after 3 retry attempts ‚Äî operator action required"
          },
          {
            "id": "n13",
            "type": "event",
            "label": "Emit retry summary event",
            "detail": "Report number of recovered records and permanent failures to event bus"
          },
          {
            "id": "n14",
            "type": "end",
            "label": "Retry pass complete ‚Äî proceed to new responses"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e4",
            "source": "n3",
            "target": "n7",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e5",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e6",
            "source": "n5",
            "target": "n6",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e7",
            "source": "n5",
            "target": "n12",
            "label": "Max retries",
            "variant": "error"
          },
          {
            "id": "e8",
            "source": "n6",
            "target": "n7"
          },
          {
            "id": "e9",
            "source": "n7",
            "target": "n8"
          },
          {
            "id": "e10",
            "source": "n8",
            "target": "n9",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e11",
            "source": "n8",
            "target": "n13",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e12",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e13",
            "source": "n10",
            "target": "n11",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e14",
            "source": "n10",
            "target": "n12",
            "label": "Max retries",
            "variant": "error"
          },
          {
            "id": "e15",
            "source": "n11",
            "target": "n13"
          },
          {
            "id": "e16",
            "source": "n12",
            "target": "n13",
            "variant": "error"
          },
          {
            "id": "e17",
            "source": "n13",
            "target": "n14"
          }
        ]
      },
      {
        "id": "flow_3",
        "name": "Detractor Escalation Flow",
        "description": "Specialized path for low-score or urgency-flagged responses requiring immediate team attention",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "Detractor response detected",
            "detail": "NPS 0‚Äì6 or urgency keyword found during response scoring phase"
          },
          {
            "id": "n2",
            "type": "action",
            "label": "Compute urgency level",
            "detail": "Score 0‚Äì3 = Critical, Score 4‚Äì6 = At-Risk. Check flags: billing, cancel, refund = Critical override"
          },
          {
            "id": "n3",
            "type": "connector",
            "label": "Create Airtable record",
            "detail": "POST /v0/{BASE_ID}/{TABLE} ‚Äî include Tier=Detractor, urgency level, and all keyword flags",
            "connector": "airtable"
          },
          {
            "id": "n4",
            "type": "connector",
            "label": "Post to #support-urgent Slack",
            "detail": "POST /api/chat.postMessage ‚Äî @mention support lead, include response excerpt and Airtable record link",
            "connector": "slack"
          },
          {
            "id": "n5",
            "type": "decision",
            "label": "Critical urgency?",
            "detail": "Is urgency level Critical (score 0‚Äì3 or billing/cancel flag)?"
          },
          {
            "id": "n6",
            "type": "connector",
            "label": "Send immediate Slack DM",
            "detail": "POST /api/chat.postMessage ‚Äî direct message to assigned support rep with full response details",
            "connector": "slack"
          },
          {
            "id": "n7",
            "type": "action",
            "label": "Compose empathetic email",
            "detail": "Select Detractor template, personalize with respondent name, specific complaint reference, and 24h resolution promise"
          },
          {
            "id": "n8",
            "type": "connector",
            "label": "Send follow-up email",
            "detail": "gmail_send ‚Äî empathetic response email with personalized subject and body",
            "connector": "google_workspace"
          },
          {
            "id": "n9",
            "type": "event",
            "label": "Emit detractor alert event",
            "detail": "Publish structured event with respondent ID, score, tier, flags for downstream tracking systems"
          },
          {
            "id": "n10",
            "type": "error",
            "label": "Escalation failure",
            "detail": "If Slack DM or email fails, write to escalation_failures.json and emit user_message to operator",
            "error_message": "Detractor escalation failed ‚Äî manual follow-up required"
          },
          {
            "id": "n11",
            "type": "end",
            "label": "Escalation complete"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4"
          },
          {
            "id": "e4",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e5",
            "source": "n5",
            "target": "n6",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e6",
            "source": "n5",
            "target": "n7",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e7",
            "source": "n6",
            "target": "n7"
          },
          {
            "id": "e8",
            "source": "n7",
            "target": "n8"
          },
          {
            "id": "e9",
            "source": "n8",
            "target": "n9"
          },
          {
            "id": "e10",
            "source": "n8",
            "target": "n10",
            "variant": "error"
          },
          {
            "id": "e11",
            "source": "n9",
            "target": "n11"
          },
          {
            "id": "e12",
            "source": "n10",
            "target": "n11",
            "variant": "error"
          }
        ]
      }
    ]
  }
}
