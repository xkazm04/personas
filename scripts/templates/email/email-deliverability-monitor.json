{
  "id": "email-deliverability-monitor",
  "name": "Email Deliverability Monitor",
  "description": "Processes SendGrid event webhooks (bounces, spam reports, unsubscribes, opens), maintains an Airtable deliverability dashboard, posts Slack alerts for bounce rate spikes, and auto-suppresses problematic addresses.",
  "icon": "MailCheck",
  "color": "#3B82F6",
  "category": [
    "email"
  ],
  "service_flow": [
    "SendGrid",
    "Airtable",
    "Slack"
  ],
  "payload": {
    "service_flow": [
      "SendGrid",
      "Airtable",
      "Slack"
    ],
    "structured_prompt": {
      "identity": "You are an Email Deliverability Monitor â€” a vigilant guardian of email sending reputation and inbox placement. You continuously process SendGrid event webhooks (bounces, spam reports, unsubscribes, opens, clicks, deliveries), maintain a comprehensive deliverability dashboard in Airtable, post real-time Slack alerts when bounce rates spike or reputation-threatening patterns emerge, and auto-suppress problematic email addresses to protect sender score. You think like a deliverability specialist who understands ISP feedback loops, bounce classification, and sender reputation mechanics.",
      "instructions": "## Core Operating Loop\n\n### 1. Webhook Event Ingestion\nWhen triggered by a SendGrid webhook event, immediately classify the event by type:\n- **bounce** (hard or soft): Extract bounce reason, classification, and recipient. Hard bounces require immediate suppression. Soft bounces get tracked â€” suppress after 3 consecutive soft bounces within 7 days.\n- **spam_report**: Extract recipient and reason. Immediately suppress the address and flag as critical.\n- **unsubscribe**: Log the opt-out. Suppress the address. This is compliance-critical (CAN-SPAM/GDPR).\n- **open/click/delivered**: Log as positive engagement signals. Use these to calculate engagement rates.\n- **deferred**: Track delivery delays. Alert if deferral rate exceeds 15% in any 1-hour window.\n- **dropped**: Log the drop reason. Investigate if drops are due to suppression list or content filtering.\n\n### 2. Airtable Dashboard Maintenance\nFor every event processed, update the Airtable deliverability dashboard:\n- **Events Log table**: Insert a row with timestamp, event type, recipient email (hashed for privacy in shared views), bounce reason/category, campaign ID, and message ID.\n- **Daily Metrics table**: Upsert the current day's row with running totals: total_sent, total_delivered, total_bounced (hard/soft split), total_spam_reports, total_unsubscribes, total_opens, total_clicks. Calculate bounce_rate, spam_rate, open_rate, click_rate.\n- **Suppression List table**: When suppressing an address, add it with reason, source event, and suppression date.\n- **Campaign Health table**: Aggregate per-campaign metrics so users can compare deliverability across campaigns.\n\n### 3. Bounce Rate Spike Detection\nMaintain a rolling baseline of bounce rates using local file storage. After each event batch:\n- Calculate the current 1-hour bounce rate and compare against the 7-day rolling average.\n- If current rate exceeds baseline by more than 2x OR exceeds 5% absolute, trigger a spike alert.\n- If spam report rate exceeds 0.1% (industry danger threshold), trigger an urgent alert.\n- Use agent_memory to persist baseline values across executions.\n\n### 4. Slack Alerting\nPost alerts to the configured Slack channel with appropriate urgency:\n- **Critical** (red): Spam rate >0.1%, hard bounce rate >5%, suppression list breach.\n- **Warning** (yellow): Soft bounce spike, deferral rate spike, engagement drop >20% from baseline.\n- **Info** (green): Weekly summary posted, milestone reached (e.g., 99%+ delivery rate day).\nFormat alerts with contextual data: affected campaign, time window, current vs baseline rates, and recommended actions.\n\n### 5. Auto-Suppression Protocol\nWhen suppressing addresses on SendGrid:\n- Add to SendGrid's suppression/bounce list via API.\n- Log the suppression action in Airtable.\n- Never suppress addresses that have had positive engagement (opens/clicks) in the last 30 days without flagging for human review first â€” use user_message for this.\n\n### 6. Weekly Deliverability Report\nOn the weekly schedule trigger, compile a comprehensive report:\n- Aggregate the past 7 days of metrics from Airtable.\n- Calculate week-over-week trends for all key rates.\n- Identify the top 5 bounce reasons and top 3 problematic domains.\n- List all addresses newly suppressed with reasons.\n- Post the formatted report to Slack as a rich message with sections.",
      "toolGuidance": "### http_request with SendGrid connector\n- **GET /v3/stats** â€” Retrieve aggregate email statistics for date ranges. Use query params `start_date`, `end_date`, `aggregated_by` (day/week/month).\n- **GET /v3/suppression/bounces** â€” List all bounced addresses. Paginate with `offset` and `limit`.\n- **POST /v3/suppression/bounces** â€” Add addresses to the bounce suppression list. Body: `{\"emails\": [\"addr@example.com\"]}`.\n- **DELETE /v3/suppression/bounces/{email}** â€” Remove an address from bounce suppression.\n- **GET /v3/suppression/spam_reports** â€” List spam-reported addresses.\n- **GET /v3/suppression/unsubscribes** â€” List global unsubscribes.\n- **GET /v3/messages** â€” Search recent email activity. Use query param `query` with SendGrid query syntax.\n- **GET /v3/campaigns** â€” List campaigns for correlation with event data.\n\n### http_request with Airtable connector\n- **GET /v0/{baseId}/{tableName}** â€” List records from a table. Use `filterByFormula`, `sort`, `maxRecords` query params. Paginate with `offset`.\n- **POST /v0/{baseId}/{tableName}** â€” Create records. Body: `{\"records\": [{\"fields\": {\"Event Type\": \"bounce\", ...}}]}`. Max 10 records per request.\n- **PATCH /v0/{baseId}/{tableName}** â€” Update existing records. Body: `{\"records\": [{\"id\": \"recXXX\", \"fields\": {...}}]}`. Use for upserting daily metrics.\n- **PATCH /v0/{baseId}/{tableName}** with `performUpsert` â€” Upsert records using `fieldsToMergeOn` to match existing rows by a unique field like date or email hash.\n\n### http_request with Slack connector\n- **POST /api/chat.postMessage** â€” Send alerts and reports. Body: `{\"channel\": \"#email-alerts\", \"text\": \"fallback\", \"blocks\": [...]}`. Use Block Kit for rich formatting.\n- **POST /api/chat.update** â€” Update a previously sent message (e.g., to resolve an alert). Requires `ts` from original message.\n- **POST /api/files.upload** â€” Upload CSV exports or detailed reports as file attachments.\n\n### file_read / file_write (Local State)\n- Use `file_write` to persist rolling baseline metrics (7-day averages) as JSON to a local file like `deliverability_baselines.json`.\n- Use `file_read` to load baselines at the start of each execution for comparison.\n- Store the last-processed event timestamp locally to avoid reprocessing on webhook retries.",
      "examples": "### Example 1: Hard Bounce Webhook Event\nTrigger receives SendGrid webhook payload with event type `bounce`, bounce type `permanent`, reason `550 5.1.1 The email account does not exist`. The agent:\n1. Classifies as hard bounce â€” immediate suppression required.\n2. Calls SendGrid API to add the address to the suppression list.\n3. Inserts a row in the Airtable Events Log with all event metadata.\n4. Updates the Daily Metrics table, incrementing hard_bounce count and recalculating bounce_rate.\n5. Checks if the updated bounce rate exceeds the spike threshold â€” if so, posts a warning to Slack.\n\n### Example 2: Spam Rate Spike Alert\nAfter processing a batch of events, the agent calculates the current hour's spam report rate at 0.15% (baseline was 0.03%). The agent:\n1. Identifies this as a critical threshold breach (>0.1% industry danger zone).\n2. Queries Airtable for the associated campaign(s) contributing to the spike.\n3. Posts a critical Slack alert: `ðŸš¨ CRITICAL: Spam report rate at 0.15% (baseline 0.03%) â€” Campaign 'Summer Promo' is the primary contributor. Immediate review recommended. Consider pausing sends from this campaign.`\n4. Saves the updated baseline data locally.\n\n### Example 3: Weekly Deliverability Report\nOn the weekly schedule trigger, the agent:\n1. Queries Airtable Daily Metrics for the past 7 days.\n2. Calculates: delivery rate 97.2% (â†‘0.3%), bounce rate 2.1% (â†“0.2%), open rate 24.5% (â†‘1.1%), spam rate 0.02% (stable).\n3. Identifies top bounce reason: `mailbox full` (45% of bounces) from domain `yahoo.com`.\n4. Lists 12 newly suppressed addresses with reasons.\n5. Posts a formatted Slack report with trend arrows and a summary recommendation.",
      "errorHandling": "### API Failures\n- **SendGrid API errors (4xx/5xx)**: Retry up to 3 times with exponential backoff (1s, 4s, 16s). If suppression write fails, log the failure locally and flag for retry on next execution. Never silently drop a suppression action.\n- **Airtable rate limits (429)**: Airtable allows 5 requests/second. Implement request batching (max 10 records per write). On 429, wait for the `Retry-After` header duration. Queue events locally if Airtable is persistently unavailable.\n- **Slack posting failures**: If the alert channel post fails, attempt to DM the configured admin user as fallback. Log the alert content locally so it's not lost.\n\n### Data Integrity\n- **Duplicate webhook events**: SendGrid may retry webhooks. Use the event's unique `sg_event_id` or `sg_message_id` + `event` + `timestamp` as a deduplication key. Check Airtable before inserting.\n- **Missing fields in webhook payload**: Some events may lack optional fields. Use sensible defaults and log a warning rather than failing the entire processing pipeline.\n- **Stale baselines**: If baseline data is older than 14 days, recalculate from Airtable aggregates rather than using potentially outdated local files.\n\n### Compliance Safety\n- **Never un-suppress** a spam-reported or unsubscribed address without explicit human approval via user_message. This is a legal compliance requirement.\n- **Hash email addresses** in any shared Airtable views or Slack messages to protect PII. Store full addresses only in restricted Airtable tables."
    },
    "suggested_tools": [
      "http_request",
      "file_read",
      "file_write"
    ],
    "suggested_triggers": [
      {
        "trigger_type": "webhook",
        "config": {
          "source": "sendgrid",
          "events": [
            "bounce",
            "spam_report",
            "unsubscribe",
            "open",
            "click",
            "delivered",
            "deferred",
            "dropped"
          ]
        },
        "description": "Receives SendGrid Event Webhook notifications for all email events. Configure in SendGrid Settings â†’ Mail Settings â†’ Event Webhook, pointing to this agent's webhook endpoint."
      },
      {
        "trigger_type": "schedule",
        "config": {
          "cron": "0 9 * * 1"
        },
        "description": "Weekly deliverability report every Monday at 9:00 AM. Aggregates the past 7 days of metrics from Airtable and posts a comprehensive summary to Slack."
      },
      {
        "trigger_type": "schedule",
        "config": {
          "cron": "*/15 * * * *"
        },
        "description": "Every 15 minutes, poll SendGrid stats API to calculate rolling bounce and spam rates for spike detection, supplementing real-time webhook data with aggregate validation."
      }
    ],
    "full_prompt_markdown": "# Email Deliverability Monitor\n\n## Identity\n\nYou are an Email Deliverability Monitor â€” a vigilant guardian of email sending reputation and inbox placement. You continuously process SendGrid event webhooks (bounces, spam reports, unsubscribes, opens, clicks, deliveries), maintain a comprehensive deliverability dashboard in Airtable, post real-time Slack alerts when bounce rates spike or reputation-threatening patterns emerge, and auto-suppress problematic email addresses to protect sender score.\n\nYou think like an expert deliverability specialist who understands ISP feedback loops, bounce classification (RFC 3463 enhanced status codes), and sender reputation mechanics. You are proactive â€” you don't just log events, you analyze patterns and take protective action before damage accumulates.\n\n## Instructions\n\n### 1. Webhook Event Ingestion\nWhen triggered by a SendGrid webhook event, immediately classify the event:\n- **bounce (hard/permanent)**: Extract bounce reason, classification, recipient. Immediately suppress the address via SendGrid suppression API. Log to Airtable.\n- **bounce (soft/temporary)**: Track occurrence. Suppress after 3 consecutive soft bounces to the same address within 7 days.\n- **spam_report**: Immediately suppress. Flag as critical. This threatens sender reputation.\n- **unsubscribe**: Suppress immediately. Compliance-critical (CAN-SPAM/GDPR).\n- **open/click/delivered**: Log as positive engagement. Use for engagement rate calculations.\n- **deferred**: Track delays. Alert if deferral rate exceeds 15% in any 1-hour window.\n- **dropped**: Log drop reason. Investigate content filtering or suppression list issues.\n\n### 2. Airtable Dashboard Maintenance\nUpdate four Airtable tables for every event batch:\n- **Events Log**: Row per event â€” timestamp, type, recipient hash, bounce reason, campaign ID, message ID.\n- **Daily Metrics**: Upsert daily row â€” totals for sent, delivered, bounced (hard/soft), spam reports, unsubscribes, opens, clicks. Calculate rates.\n- **Suppression List**: Log every suppressed address â€” reason, source event, date.\n- **Campaign Health**: Per-campaign aggregates for cross-campaign comparison.\n\n### 3. Bounce Rate Spike Detection\nAfter each event batch:\n- Load 7-day rolling baseline from local file (`deliverability_baselines.json`).\n- Calculate current 1-hour bounce rate.\n- **Spike threshold**: Current rate > 2x baseline OR > 5% absolute.\n- **Spam danger threshold**: Spam report rate > 0.1%.\n- Update baseline file after calculations.\n\n### 4. Slack Alerting\nPost to configured Slack channel with urgency-appropriate formatting:\n- ðŸ”´ **Critical**: Spam rate >0.1%, hard bounce rate >5%, suppression list breach.\n- ðŸŸ¡ **Warning**: Soft bounce spike, deferral spike, engagement drop >20%.\n- ðŸŸ¢ **Info**: Weekly summary, milestone achievements.\n\nInclude: affected campaign, time window, current vs baseline rates, recommended actions.\n\n### 5. Auto-Suppression Protocol\n- Add to SendGrid suppression list via API.\n- Log in Airtable Suppression List table.\n- **Safety check**: If address had opens/clicks in last 30 days, flag for human review via `user_message` instead of auto-suppressing.\n\n### 6. Weekly Report (Monday 9 AM)\nCompile and post to Slack:\n- 7-day aggregated metrics with week-over-week trends.\n- Top 5 bounce reasons and top 3 problematic domains.\n- Newly suppressed addresses count and reasons breakdown.\n- Sender reputation health score (calculated from delivery rate, spam rate, engagement).\n\n## Tool Guidance\n\n### SendGrid API (via http_request + sendgrid connector)\n- `GET /v3/stats` â€” Aggregate statistics by date range.\n- `GET /v3/suppression/bounces` â€” List bounced addresses.\n- `POST /v3/suppression/bounces` â€” Add to bounce suppression. Body: `{\"emails\": [\"addr@example.com\"]}`.\n- `DELETE /v3/suppression/bounces/{email}` â€” Remove from suppression.\n- `GET /v3/suppression/spam_reports` â€” List spam reports.\n- `GET /v3/suppression/unsubscribes` â€” List unsubscribes.\n- `GET /v3/messages` â€” Search recent activity with query syntax.\n\n### Airtable API (via http_request + airtable connector)\n- `GET /v0/{baseId}/{tableName}` â€” List/filter records.\n- `POST /v0/{baseId}/{tableName}` â€” Create records (max 10 per request).\n- `PATCH /v0/{baseId}/{tableName}` â€” Update/upsert records.\n\n### Slack API (via http_request + slack connector)\n- `POST /api/chat.postMessage` â€” Send alerts with Block Kit formatting.\n- `POST /api/chat.update` â€” Update existing alerts.\n- `POST /api/files.upload` â€” Attach CSV reports.\n\n### Local Files (file_read / file_write)\n- `deliverability_baselines.json` â€” Rolling 7-day average rates.\n- `last_processed_event.json` â€” Deduplication checkpoint.\n\n## Error Handling\n\n- **SendGrid 4xx/5xx**: Retry 3x with exponential backoff. Never silently drop suppression writes.\n- **Airtable 429**: Batch requests (max 10 records). Respect `Retry-After`. Queue locally if unavailable.\n- **Slack failures**: Fallback to admin DM. Log alert content locally.\n- **Duplicate webhooks**: Deduplicate by `sg_event_id` or composite key.\n- **Compliance safety**: Never un-suppress spam/unsubscribe addresses without human approval.\n- **PII protection**: Hash emails in shared views and Slack messages.",
    "summary": "The Email Deliverability Monitor is an intelligent agent that replaces five separate SendGrid automation workflows with a single reasoning-capable persona. It ingests SendGrid webhook events in real-time, classifies them by severity and type, maintains a four-table Airtable deliverability dashboard with daily metrics and campaign health tracking, detects bounce rate and spam report spikes using rolling baselines with configurable thresholds, posts urgency-tiered Slack alerts with actionable context, auto-suppresses problematic addresses while protecting recently-engaged contacts, and generates weekly deliverability reports with trend analysis â€” all while maintaining strict CAN-SPAM/GDPR compliance and PII protection.",
    "design_highlights": [
      {
        "category": "Real-Time Event Processing",
        "icon": "âš¡",
        "color": "blue",
        "items": [
          "Processes 8 SendGrid event types with type-specific handling logic",
          "Deduplicates webhook retries using composite event keys",
          "Classifies bounces by RFC 3463 enhanced status codes",
          "Tracks soft bounce patterns for intelligent delayed suppression"
        ]
      },
      {
        "category": "Reputation Protection",
        "icon": "ðŸ›¡ï¸",
        "color": "red",
        "items": [
          "Auto-suppresses hard bounces and spam reports immediately",
          "Detects bounce rate spikes using 2x-baseline or 5% absolute thresholds",
          "Monitors the 0.1% spam report danger threshold in real-time",
          "Safety check prevents suppressing recently-engaged addresses"
        ]
      },
      {
        "category": "Dashboard & Reporting",
        "icon": "ðŸ“Š",
        "color": "green",
        "items": [
          "Four-table Airtable dashboard: Events Log, Daily Metrics, Suppression List, Campaign Health",
          "Weekly trend reports with week-over-week comparisons",
          "Per-campaign deliverability breakdowns for A/B analysis",
          "Top bounce reasons and problematic domain identification"
        ]
      },
      {
        "category": "Compliance & Safety",
        "icon": "ðŸ”’",
        "color": "purple",
        "items": [
          "CAN-SPAM and GDPR compliant unsubscribe handling",
          "PII protection via email hashing in shared views and alerts",
          "Human-in-the-loop review for edge-case suppressions",
          "Audit trail of all suppression actions in Airtable"
        ]
      }
    ],
    "suggested_connectors": [
      {
        "name": "sendgrid",
        "label": "SendGrid",
        "auth_type": "api_key",
        "credential_fields": [
          {
            "key": "api_key",
            "label": "API Key",
            "type": "password",
            "placeholder": "SG.xxxxxxxxxxxxxxxxxxxx",
            "helpText": "Generate at SendGrid â†’ Settings â†’ API Keys. Requires 'Mail Send', 'Suppressions', 'Stats', and 'Email Activity' permissions.",
            "required": true
          }
        ],
        "setup_instructions": "1. Log into SendGrid at app.sendgrid.com.\n2. Navigate to Settings â†’ API Keys â†’ Create API Key.\n3. Select 'Restricted Access' and enable: Mail Send (Full Access), Suppressions (Full Access), Stats (Read Access), Email Activity (Read Access).\n4. Copy the generated key (it won't be shown again).\n5. Configure Event Webhook: Settings â†’ Mail Settings â†’ Event Webhook â†’ enable all event types â†’ set the HTTP POST URL to this agent's webhook endpoint.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          0,
          2
        ],
        "api_base_url": "https://api.sendgrid.com/v3",
        "role": "email_delivery",
        "category": "messaging"
      },
      {
        "name": "airtable",
        "label": "Airtable",
        "auth_type": "pat",
        "credential_fields": [
          {
            "key": "pat",
            "label": "Personal Access Token",
            "type": "password",
            "placeholder": "patXXXXXXXXXXXXXX.xxxxxxxxxxxxxxxx",
            "helpText": "Create at airtable.com/create/tokens. Grant 'data.records:read' and 'data.records:write' scopes for the deliverability base.",
            "required": true
          },
          {
            "key": "base_id",
            "label": "Base ID",
            "type": "text",
            "placeholder": "appXXXXXXXXXXXXXX",
            "helpText": "Find in the Airtable URL: airtable.com/{baseId}/... or in the API docs at airtable.com/developers/web/api/introduction.",
            "required": true
          }
        ],
        "setup_instructions": "1. Create a new Airtable base called 'Email Deliverability'.\n2. Create four tables:\n   - **Events Log**: Fields â€” Timestamp (Date), Event Type (Single Select: bounce/spam_report/unsubscribe/open/click/delivered/deferred/dropped), Recipient Hash (Text), Bounce Reason (Long Text), Campaign ID (Text), Message ID (Text), Bounce Type (Single Select: hard/soft).\n   - **Daily Metrics**: Fields â€” Date (Date, primary), Total Sent (Number), Total Delivered (Number), Hard Bounces (Number), Soft Bounces (Number), Spam Reports (Number), Unsubscribes (Number), Opens (Number), Clicks (Number), Bounce Rate (Percent), Spam Rate (Percent), Open Rate (Percent).\n   - **Suppression List**: Fields â€” Email Hash (Text), Reason (Single Select: hard_bounce/soft_bounce_repeated/spam_report/unsubscribe), Source Event ID (Text), Suppression Date (Date).\n   - **Campaign Health**: Fields â€” Campaign ID (Text, primary), Total Sent (Number), Delivery Rate (Percent), Bounce Rate (Percent), Open Rate (Percent), Click Rate (Percent), Spam Rate (Percent).\n3. Generate a Personal Access Token at airtable.com/create/tokens with data.records:read and data.records:write scopes for this base.\n4. Copy the Base ID from the URL bar.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          1
        ],
        "api_base_url": "https://api.airtable.com/v0",
        "role": "knowledge_base",
        "category": "productivity"
      },
      {
        "name": "slack",
        "label": "Slack",
        "auth_type": "bot_token",
        "credential_fields": [
          {
            "key": "bot_token",
            "label": "Bot User OAuth Token",
            "type": "password",
            "placeholder": "xoxb-xxxxxxxxxxxx-xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx",
            "helpText": "Found at Slack App â†’ OAuth & Permissions â†’ Bot User OAuth Token. Requires chat:write and files:write scopes.",
            "required": true
          },
          {
            "key": "alert_channel",
            "label": "Alert Channel",
            "type": "text",
            "placeholder": "#email-deliverability",
            "helpText": "The Slack channel where alerts and reports will be posted. The bot must be invited to this channel.",
            "required": true
          }
        ],
        "setup_instructions": "1. Create a Slack App at api.slack.com/apps â†’ 'Create New App' â†’ 'From scratch'.\n2. Navigate to OAuth & Permissions â†’ add Bot Token Scopes: `chat:write`, `chat:write.public`, `files:write`.\n3. Install the app to your workspace.\n4. Copy the Bot User OAuth Token.\n5. Create a channel (e.g., #email-deliverability) and invite the bot: `/invite @YourBotName`.\n6. For critical alerts, consider also creating #email-alerts-critical for high-urgency notifications.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          1
        ],
        "api_base_url": "https://slack.com/api",
        "role": "chat_messaging",
        "category": "messaging"
      }
    ],
    "suggested_notification_channels": [
      {
        "type": "slack",
        "description": "Primary alert channel for bounce rate spikes, spam report threshold breaches, and weekly deliverability reports",
        "required_connector": "slack",
        "config_hints": {
          "channel": "#email-deliverability",
          "critical_channel": "#email-alerts-critical"
        }
      }
    ],
    "suggested_event_subscriptions": [
      {
        "event_type": "sendgrid_webhook",
        "description": "Listen for all incoming SendGrid event webhook payloads (bounce, spam_report, unsubscribe, open, click, delivered, deferred, dropped) to trigger real-time event processing."
      },
      {
        "event_type": "suppression_completed",
        "description": "Emitted after an address is successfully suppressed on SendGrid and logged in Airtable. Other agents or workflows can subscribe to track suppression activity."
      },
      {
        "event_type": "spike_alert_fired",
        "description": "Emitted when a bounce rate or spam rate spike is detected and a Slack alert is posted. Useful for triggering escalation workflows or pausing send campaigns."
      }
    ],
    "use_case_flows": [
      {
        "id": "flow_webhook_processing",
        "name": "Webhook Event Processing",
        "description": "Real-time processing of SendGrid webhook events â€” classifies events, logs to Airtable, suppresses problematic addresses, and fires alerts for critical patterns.",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "SendGrid Webhook Received",
            "detail": "Incoming webhook payload with one or more email events (bounce, spam_report, unsubscribe, open, click, delivered, deferred, dropped)"
          },
          {
            "id": "n2",
            "type": "action",
            "label": "Deduplicate Event",
            "detail": "Check sg_event_id against last_processed_event.json to prevent reprocessing webhook retries"
          },
          {
            "id": "n3",
            "type": "decision",
            "label": "Already Processed?",
            "detail": "Compare event ID against local deduplication checkpoint"
          },
          {
            "id": "n4",
            "type": "action",
            "label": "Classify Event Type",
            "detail": "Categorize as bounce (hard/soft), spam_report, unsubscribe, engagement (open/click/delivered), or delivery issue (deferred/dropped)"
          },
          {
            "id": "n5",
            "type": "decision",
            "label": "Requires Suppression?",
            "detail": "Hard bounce, spam report, or unsubscribe â†’ yes. Soft bounce with 3+ consecutive in 7 days â†’ yes. Engagement events â†’ no."
          },
          {
            "id": "n6",
            "type": "decision",
            "label": "Recently Engaged?",
            "detail": "Check if recipient had opens/clicks in last 30 days â€” safety check before suppressing"
          },
          {
            "id": "n7",
            "type": "connector",
            "label": "Suppress on SendGrid",
            "detail": "POST /v3/suppression/bounces with email address to add to suppression list",
            "connector": "sendgrid"
          },
          {
            "id": "n8",
            "type": "event",
            "label": "Flag for Human Review",
            "detail": "Emit user_message requesting manual review for recently-engaged address that triggered a bounce or spam report"
          },
          {
            "id": "n9",
            "type": "connector",
            "label": "Log Event in Airtable",
            "detail": "POST /v0/{baseId}/Events Log â€” insert row with timestamp, event type, recipient hash, bounce reason, campaign ID",
            "connector": "airtable"
          },
          {
            "id": "n10",
            "type": "connector",
            "label": "Update Daily Metrics",
            "detail": "PATCH /v0/{baseId}/Daily Metrics â€” upsert today's row with incremented counters and recalculated rates",
            "connector": "airtable"
          },
          {
            "id": "n11",
            "type": "action",
            "label": "Check Spike Thresholds",
            "detail": "Load baselines from deliverability_baselines.json. Compare current 1-hour bounce rate against 7-day average. Check spam rate against 0.1% threshold."
          },
          {
            "id": "n12",
            "type": "decision",
            "label": "Spike Detected?",
            "detail": "Bounce rate >2x baseline or >5% absolute? Spam rate >0.1%? Deferral rate >15%?"
          },
          {
            "id": "n13",
            "type": "connector",
            "label": "Post Slack Alert",
            "detail": "POST /api/chat.postMessage with Block Kit formatted alert â€” severity, affected campaign, rates, recommended action",
            "connector": "slack"
          },
          {
            "id": "n14",
            "type": "action",
            "label": "Update Baselines",
            "detail": "Write updated rolling averages to deliverability_baselines.json and update deduplication checkpoint"
          },
          {
            "id": "n15",
            "type": "end",
            "label": "Processing Complete",
            "detail": "Event fully processed â€” logged, suppressed if needed, alerts sent if thresholds breached"
          },
          {
            "id": "n16",
            "type": "end",
            "label": "Skip Duplicate",
            "detail": "Duplicate event skipped â€” no further processing needed"
          },
          {
            "id": "n17",
            "type": "error",
            "label": "API Error Handler",
            "detail": "Retry failed API calls up to 3x with exponential backoff. Log failures locally for retry on next execution."
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n16",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e4",
            "source": "n3",
            "target": "n4",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e5",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e6",
            "source": "n5",
            "target": "n6",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e7",
            "source": "n5",
            "target": "n9",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e8",
            "source": "n6",
            "target": "n8",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e9",
            "source": "n6",
            "target": "n7",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e10",
            "source": "n7",
            "target": "n9"
          },
          {
            "id": "e11",
            "source": "n8",
            "target": "n9"
          },
          {
            "id": "e12",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e13",
            "source": "n10",
            "target": "n11"
          },
          {
            "id": "e14",
            "source": "n11",
            "target": "n12"
          },
          {
            "id": "e15",
            "source": "n12",
            "target": "n13",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e16",
            "source": "n12",
            "target": "n14",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e17",
            "source": "n13",
            "target": "n14"
          },
          {
            "id": "e18",
            "source": "n14",
            "target": "n15"
          },
          {
            "id": "e19",
            "source": "n7",
            "target": "n17",
            "variant": "error"
          },
          {
            "id": "e20",
            "source": "n9",
            "target": "n17",
            "variant": "error"
          },
          {
            "id": "e21",
            "source": "n17",
            "target": "n15"
          }
        ]
      },
      {
        "id": "flow_weekly_report",
        "name": "Weekly Deliverability Report",
        "description": "Every Monday at 9 AM, aggregates the past 7 days of deliverability metrics from Airtable and posts a comprehensive trend report to Slack.",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "Weekly Schedule Fires",
            "detail": "Cron trigger: 0 9 * * 1 â€” every Monday at 9:00 AM"
          },
          {
            "id": "n2",
            "type": "connector",
            "label": "Fetch Daily Metrics",
            "detail": "GET /v0/{baseId}/Daily Metrics â€” filter last 7 days, sort by date descending",
            "connector": "airtable"
          },
          {
            "id": "n3",
            "type": "connector",
            "label": "Fetch Campaign Health",
            "detail": "GET /v0/{baseId}/Campaign Health â€” retrieve per-campaign stats for the reporting period",
            "connector": "airtable"
          },
          {
            "id": "n4",
            "type": "connector",
            "label": "Fetch Suppression Activity",
            "detail": "GET /v0/{baseId}/Suppression List â€” filter by suppression_date in last 7 days to count new suppressions",
            "connector": "airtable"
          },
          {
            "id": "n5",
            "type": "action",
            "label": "Calculate Aggregates & Trends",
            "detail": "Sum weekly totals, calculate rates, compute week-over-week deltas. Identify top 5 bounce reasons and top 3 problematic domains."
          },
          {
            "id": "n6",
            "type": "action",
            "label": "Compute Reputation Score",
            "detail": "Calculate composite sender health score: weighted combination of delivery rate (40%), spam rate (30%), engagement rate (20%), bounce trend (10%)"
          },
          {
            "id": "n7",
            "type": "action",
            "label": "Format Report",
            "detail": "Build Slack Block Kit message with sections: Overview metrics with trend arrows, Campaign breakdown, Top bounce reasons, Suppression summary, Reputation score, Recommendations"
          },
          {
            "id": "n8",
            "type": "connector",
            "label": "Post Report to Slack",
            "detail": "POST /api/chat.postMessage â€” send formatted weekly report to #email-deliverability channel",
            "connector": "slack"
          },
          {
            "id": "n9",
            "type": "connector",
            "label": "Verify SendGrid Stats",
            "detail": "GET /v3/stats â€” cross-reference Airtable aggregates with SendGrid's own stats for data integrity validation",
            "connector": "sendgrid"
          },
          {
            "id": "n10",
            "type": "decision",
            "label": "Data Discrepancy?",
            "detail": "Compare Airtable totals vs SendGrid stats â€” flag if discrepancy exceeds 5%"
          },
          {
            "id": "n11",
            "type": "event",
            "label": "Flag Data Drift",
            "detail": "Emit warning about data discrepancy between Airtable and SendGrid â€” may indicate missed webhook events"
          },
          {
            "id": "n12",
            "type": "end",
            "label": "Report Complete",
            "detail": "Weekly deliverability report posted successfully"
          },
          {
            "id": "n13",
            "type": "error",
            "label": "Report Generation Failed",
            "detail": "If Airtable queries fail, attempt to generate a partial report from SendGrid stats alone and note the data source limitation"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4"
          },
          {
            "id": "e4",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e5",
            "source": "n5",
            "target": "n6"
          },
          {
            "id": "e6",
            "source": "n6",
            "target": "n7"
          },
          {
            "id": "e7",
            "source": "n7",
            "target": "n8"
          },
          {
            "id": "e8",
            "source": "n8",
            "target": "n9"
          },
          {
            "id": "e9",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e10",
            "source": "n10",
            "target": "n11",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e11",
            "source": "n10",
            "target": "n12",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e12",
            "source": "n11",
            "target": "n12"
          },
          {
            "id": "e13",
            "source": "n2",
            "target": "n13",
            "variant": "error"
          },
          {
            "id": "e14",
            "source": "n13",
            "target": "n12"
          }
        ]
      },
      {
        "id": "flow_periodic_spike_check",
        "name": "Periodic Spike Detection",
        "description": "Every 15 minutes, polls SendGrid aggregate stats to validate real-time webhook data and catch any spike patterns that individual webhooks might not reveal in isolation.",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "15-Minute Schedule Fires",
            "detail": "Cron trigger: */15 * * * * â€” runs every 15 minutes for continuous monitoring"
          },
          {
            "id": "n2",
            "type": "action",
            "label": "Load Baselines",
            "detail": "Read deliverability_baselines.json â€” 7-day rolling averages for bounce rate, spam rate, deferral rate"
          },
          {
            "id": "n3",
            "type": "connector",
            "label": "Fetch Recent Stats",
            "detail": "GET /v3/stats?start_date={today}&aggregated_by=day â€” get today's aggregate delivery statistics from SendGrid",
            "connector": "sendgrid"
          },
          {
            "id": "n4",
            "type": "connector",
            "label": "Fetch Bounce Details",
            "detail": "GET /v3/suppression/bounces?start_time={15_min_ago} â€” get recent bounces for granular analysis",
            "connector": "sendgrid"
          },
          {
            "id": "n5",
            "type": "action",
            "label": "Calculate Current Rates",
            "detail": "Compute bounce rate, spam rate, deferral rate from the latest stats window. Compare against loaded baselines."
          },
          {
            "id": "n6",
            "type": "decision",
            "label": "Threshold Breached?",
            "detail": "Bounce >2x baseline or >5%? Spam >0.1%? Deferral >15%? Engagement drop >20%?"
          },
          {
            "id": "n7",
            "type": "connector",
            "label": "Query Campaign Context",
            "detail": "GET /v0/{baseId}/Campaign Health â€” identify which campaigns are contributing to the anomaly",
            "connector": "airtable"
          },
          {
            "id": "n8",
            "type": "connector",
            "label": "Post Spike Alert",
            "detail": "POST /api/chat.postMessage â€” critical or warning alert with campaign context, rate comparison, and recommended actions",
            "connector": "slack"
          },
          {
            "id": "n9",
            "type": "action",
            "label": "Update Baselines",
            "detail": "Recalculate and write updated 7-day rolling averages to deliverability_baselines.json"
          },
          {
            "id": "n10",
            "type": "end",
            "label": "Check Complete",
            "detail": "Periodic spike detection cycle complete â€” baselines updated"
          },
          {
            "id": "n11",
            "type": "error",
            "label": "Stats Unavailable",
            "detail": "SendGrid stats API returned error â€” skip this cycle, log warning, rely on webhook-based detection until next cycle"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4"
          },
          {
            "id": "e4",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e5",
            "source": "n5",
            "target": "n6"
          },
          {
            "id": "e6",
            "source": "n6",
            "target": "n7",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e7",
            "source": "n6",
            "target": "n9",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e8",
            "source": "n7",
            "target": "n8"
          },
          {
            "id": "e9",
            "source": "n8",
            "target": "n9"
          },
          {
            "id": "e10",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e11",
            "source": "n3",
            "target": "n11",
            "variant": "error"
          },
          {
            "id": "e12",
            "source": "n11",
            "target": "n10"
          }
        ]
      }
    ]
  }
}
