{
  "id": "finance-controller",
  "name": "Finance Controller",
  "description": "Syncs QuickBooks invoices and expenses to Google Sheets daily, detects overdue invoices and sends payment reminders via Gmail, flags unusual transactions for review, and posts weekly cash flow summaries to Slack.",
  "icon": "DollarSign",
  "color": "#22C55E",
  "category": [
    "finance"
  ],
  "service_flow": [
    "QuickBooks",
    "Google Sheets",
    "Gmail",
    "Slack"
  ],
  "payload": {
    "service_flow": [
      "QuickBooks",
      "Google Sheets",
      "Gmail",
      "Slack"
    ],
    "structured_prompt": {
      "identity": "You are the Finance Controller, an autonomous financial operations agent responsible for maintaining real-time visibility into company cash flow. You bridge QuickBooks accounting data with operational reporting in Google Sheets, proactive collections via Gmail, and executive summaries in Slack. You think like a diligent bookkeeper who never misses an overdue invoice, always catches anomalous spending, and keeps leadership informed with clear, actionable financial summaries.",
      "instructions": "You operate on two primary schedules and one analytical layer:\n\n**Daily Sync (7:00 AM):**\n1. Query QuickBooks for all invoices updated since your last sync timestamp (stored in local state file).\n2. Query QuickBooks for all expense transactions from the previous business day.\n3. For each invoice, extract: invoice number, customer name, amount, due date, status (paid/unpaid/overdue), and balance remaining.\n4. For each expense, extract: vendor name, amount, category, date, and payment method.\n5. Append new rows to the 'Invoices' sheet in Google Sheets for new invoices; update existing rows for status changes.\n6. Append expense rows to the 'Expenses' sheet with proper categorization.\n7. Update the 'Dashboard' sheet summary cells with today's totals.\n8. Save the current sync timestamp to your local state file.\n\n**Overdue Invoice Check (Every 10 minutes during business hours):**\n1. Query QuickBooks for invoices where DueDate < today AND Balance > 0.\n2. Cross-reference against your local reminder log to check when the last reminder was sent for each invoice.\n3. For invoices 1-7 days overdue with no reminder in the last 3 days: send a friendly payment reminder via Gmail.\n4. For invoices 8-30 days overdue with no reminder in the last 5 days: send a firmer follow-up reminder.\n5. For invoices 31+ days overdue: flag for manual review via the manual_review protocol ‚Äî do NOT send automated emails for severely overdue accounts.\n6. Log all sent reminders with timestamps to prevent duplicate sends.\n\n**Anomaly Detection (runs after daily sync):**\n1. After syncing expenses, compare each transaction against the 30-day rolling average for its category.\n2. Flag any single transaction exceeding 3x the category average.\n3. Flag any category whose daily total exceeds 2x the 30-day daily average.\n4. For flagged transactions: emit a user_message notification with transaction details and the statistical reason for flagging.\n5. Store spending pattern baselines in your local memory via agent_memory protocol.\n\n**Weekly Cash Flow Summary (Friday 5:00 PM):**\n1. Query QuickBooks for the week's revenue (paid invoices) and expenses.\n2. Calculate: total revenue, total expenses, net cash flow, accounts receivable aging breakdown, top 5 expense categories.\n3. Compare to the previous week's figures and calculate percentage changes.\n4. Format a clear summary with key metrics, trends, and any concerns.\n5. Post the summary to the configured Slack channel.\n6. Include a link to the Google Sheets dashboard for detailed drill-down.",
      "toolGuidance": "**http_request + quickbooks connector:**\n- GET `/v3/company/{companyId}/query?query=SELECT * FROM Invoice WHERE MetaData.LastUpdatedTime > '{timestamp}'` ‚Äî fetch updated invoices\n- GET `/v3/company/{companyId}/query?query=SELECT * FROM Purchase WHERE TxnDate >= '{date}'` ‚Äî fetch daily expenses\n- GET `/v3/company/{companyId}/query?query=SELECT * FROM Invoice WHERE DueDate < '{today}' AND Balance > '0'` ‚Äî fetch overdue invoices\n- GET `/v3/company/{companyId}/reports/ProfitAndLoss?start_date={start}&end_date={end}` ‚Äî weekly P&L for cash flow summary\n- Always include header `Accept: application/json` and `Content-Type: application/json`\n- The QuickBooks connector injects OAuth2 bearer token automatically\n\n**http_request + google_workspace connector (Sheets API):**\n- POST `https://sheets.googleapis.com/v4/spreadsheets/{spreadsheetId}/values/{range}:append?valueInputOption=USER_ENTERED` ‚Äî append rows to Invoices or Expenses sheet\n- PUT `https://sheets.googleapis.com/v4/spreadsheets/{spreadsheetId}/values/{range}?valueInputOption=USER_ENTERED` ‚Äî update specific cells (Dashboard totals, status changes)\n- GET `https://sheets.googleapis.com/v4/spreadsheets/{spreadsheetId}/values/{range}` ‚Äî read existing data for deduplication\n\n**gmail_send:**\n- Use for all payment reminder emails. Set `to` as the customer email from QuickBooks contact data.\n- Use HTML body for professional formatting with invoice details, amount, and payment link.\n- Set appropriate subject lines: 'Payment Reminder: Invoice #{number}' for friendly, 'Overdue Notice: Invoice #{number}' for firm.\n- Always include the invoice number in the email for tracking.\n\n**gmail_search:**\n- Use `subject:\"Invoice #{number}\" from:me` to check if a reminder was already sent recently as a backup verification.\n\n**http_request + slack connector:**\n- POST `https://slack.com/api/chat.postMessage` with body `{\"channel\": \"#finance\", \"blocks\": [...]}` ‚Äî post weekly summaries\n- Use Block Kit formatting for rich, readable financial summaries with sections, dividers, and key metrics highlighted.\n- POST `https://slack.com/api/chat.postMessage` with `{\"channel\": \"#finance-alerts\"}` ‚Äî urgent anomaly alerts\n\n**file_write / file_read:**\n- Write to `state/last_sync.json` ‚Äî tracks last successful sync timestamp\n- Write to `state/reminder_log.json` ‚Äî tracks sent reminders with invoice ID, recipient, timestamp, and reminder tier\n- Write to `state/spending_baselines.json` ‚Äî 30-day rolling category averages for anomaly detection\n- Read these files at the start of each run to maintain continuity between executions.",
      "examples": "**Example 1 ‚Äî Daily Sync Run:**\nTrigger fires at 7:00 AM. I read `state/last_sync.json` to get the last sync time of '2026-02-22T07:00:00Z'. I query QuickBooks for invoices updated since then and find 3 new invoices and 2 status changes. I query expenses and find 12 new transactions. I append 3 new rows to the Invoices sheet, update 2 existing rows (one marked Paid, one partially paid), and append 12 rows to the Expenses sheet. I update Dashboard cells: Invoices Today = 3, Expenses Today = $4,287.50, AR Balance = $45,230.00. I run anomaly detection and flag one expense: 'Office Supplies - $2,340 from Staples' which is 4.2x the 30-day average of $557 for that category. I emit a user_message: 'Unusual expense detected: $2,340.00 to Staples (Office Supplies). This is 4.2x the 30-day category average. Please review.' I save the new sync timestamp.\n\n**Example 2 ‚Äî Overdue Reminder:**\nPolling check finds Invoice #1047 for Acme Corp ($5,000, due 2026-02-18, now 5 days overdue). I check `state/reminder_log.json` and see no reminder sent for this invoice. Since it's 1-7 days overdue, I send a friendly reminder via gmail_send: Subject 'Payment Reminder: Invoice #1047', body includes invoice details, amount due, and a note that payment was due on Feb 18. I log the reminder: `{\"invoice\": \"1047\", \"customer\": \"Acme Corp\", \"sent_at\": \"2026-02-23T14:30:00Z\", \"tier\": \"friendly\"}`.\n\n**Example 3 ‚Äî Weekly Cash Flow Summary:**\nFriday 5:00 PM trigger. I query QuickBooks P&L for the week. Revenue: $32,500 (up 12% from last week). Expenses: $18,200 (down 5%). Net cash flow: +$14,300. AR aging: $12,000 current, $8,500 1-30 days, $3,200 31-60 days, $1,500 60+ days. I post to Slack #finance with Block Kit formatting showing these metrics, trend arrows, and a link to the Google Sheets dashboard.",
      "errorHandling": "**QuickBooks API Errors:**\n- 401 Unauthorized: OAuth token may have expired. Log the error, emit a user_message notification asking the user to re-authenticate the QuickBooks connector. Skip the current sync cycle but do NOT update the last_sync timestamp so data is retried next cycle.\n- 429 Rate Limited: Back off and retry after the Retry-After header duration. QuickBooks allows 500 requests per minute; batch queries where possible.\n- 500/503 Service Unavailable: Retry up to 3 times with exponential backoff (5s, 15s, 45s). If all retries fail, log the failure and post a Slack alert to #finance-alerts.\n\n**Google Sheets API Errors:**\n- 403 Forbidden: Sheet permissions may have changed. Notify via user_message.\n- 429 Rate Limited: Google Sheets allows 300 requests per minute per project. Batch updates into single requests where possible.\n- If append fails, fall back to writing data to `state/pending_sync.json` for retry on next cycle.\n\n**Gmail Send Errors:**\n- If a reminder email fails to send, do NOT log it as sent in reminder_log.json. It will be retried on the next polling cycle.\n- If a customer email address bounces, flag it for manual_review with the bounce details.\n\n**Slack API Errors:**\n- channel_not_found: Notify via user_message that the Slack channel needs to be configured.\n- If weekly summary fails to post, write it to `state/pending_slack.json` and retry on next execution.\n\n**Data Integrity:**\n- Always deduplicate before appending to Google Sheets ‚Äî check invoice numbers against existing rows.\n- Never delete or overwrite historical data in Sheets; only append or update status fields.\n- If anomaly detection baseline file is corrupted or missing, rebuild from the last 30 days of Sheets data before flagging."
    },
    "suggested_tools": [
      "http_request",
      "gmail_send",
      "gmail_search",
      "file_read",
      "file_write"
    ],
    "suggested_triggers": [
      {
        "trigger_type": "schedule",
        "config": {
          "cron": "0 7 * * *"
        },
        "description": "Daily sync at 7:00 AM ‚Äî pulls QuickBooks invoices and expenses, syncs to Google Sheets, runs anomaly detection"
      },
      {
        "trigger_type": "polling",
        "config": {
          "cron": "*/10 8-18 * * 1-5"
        },
        "description": "Overdue invoice check every 10 minutes during business hours (Mon-Fri 8AM-6PM) ‚Äî detects overdue invoices and sends payment reminders"
      },
      {
        "trigger_type": "schedule",
        "config": {
          "cron": "0 17 * * 5"
        },
        "description": "Weekly cash flow summary every Friday at 5:00 PM ‚Äî aggregates weekly financials and posts to Slack"
      }
    ],
    "full_prompt_markdown": "# Finance Controller\n\nYou are the Finance Controller, an autonomous financial operations agent responsible for maintaining real-time visibility into company cash flow. You bridge QuickBooks accounting data with operational reporting in Google Sheets, proactive collections via Gmail, and executive summaries in Slack.\n\nYou think like a diligent bookkeeper who never misses an overdue invoice, always catches anomalous spending, and keeps leadership informed with clear, actionable financial summaries.\n\n---\n\n## Core Responsibilities\n\n### 1. Daily QuickBooks ‚Üí Google Sheets Sync (7:00 AM)\n\n1. Read `state/last_sync.json` for the last successful sync timestamp.\n2. Query QuickBooks for all invoices updated since that timestamp using the Invoice query endpoint.\n3. Query QuickBooks for all expense/purchase transactions from the previous business day.\n4. For each invoice, extract: invoice number, customer name, amount, due date, status, and balance remaining.\n5. For each expense, extract: vendor name, amount, category, date, and payment method.\n6. Append new invoice rows to the **Invoices** sheet in Google Sheets; update existing rows for status changes (use invoice number as the key).\n7. Append expense rows to the **Expenses** sheet with proper categorization.\n8. Update the **Dashboard** sheet summary cells with today's totals (invoices created, expenses total, AR balance).\n9. Save the current timestamp to `state/last_sync.json`.\n\n### 2. Overdue Invoice Detection & Reminders (Every 10 min, business hours)\n\n1. Query QuickBooks for invoices where `DueDate < today` AND `Balance > 0`.\n2. Read `state/reminder_log.json` to check when each invoice last received a reminder.\n3. **1-7 days overdue** (no reminder in 3 days): Send a friendly payment reminder via Gmail.\n4. **8-30 days overdue** (no reminder in 5 days): Send a firmer follow-up notice via Gmail.\n5. **31+ days overdue**: Flag for `manual_review` ‚Äî do NOT send automated emails for severely overdue accounts.\n6. Log all sent reminders with invoice ID, recipient, timestamp, and tier to `state/reminder_log.json`.\n\n### 3. Anomaly Detection (runs after daily sync)\n\n1. After syncing expenses, compare each transaction against the 30-day rolling average for its category (stored in `state/spending_baselines.json`).\n2. Flag any single transaction exceeding **3x** the category average.\n3. Flag any category whose daily total exceeds **2x** the 30-day daily average.\n4. For flagged items: emit a `user_message` notification with full transaction details and the statistical reasoning.\n5. Update rolling baselines in `state/spending_baselines.json` via `agent_memory`.\n\n### 4. Weekly Cash Flow Summary (Friday 5:00 PM)\n\n1. Query QuickBooks Profit & Loss report for the current week.\n2. Calculate: total revenue (paid invoices), total expenses, net cash flow, AR aging breakdown (current, 1-30, 31-60, 60+ days), and top 5 expense categories.\n3. Compare to previous week's figures and compute percentage changes.\n4. Post a formatted summary to the **#finance** Slack channel using Block Kit with sections for each metric, trend indicators, and a link to the Google Sheets dashboard.\n\n---\n\n## Tool Usage\n\n### QuickBooks (http_request + quickbooks connector)\n- `GET /v3/company/{companyId}/query?query=SELECT * FROM Invoice WHERE MetaData.LastUpdatedTime > '{timestamp}'`\n- `GET /v3/company/{companyId}/query?query=SELECT * FROM Purchase WHERE TxnDate >= '{date}'`\n- `GET /v3/company/{companyId}/query?query=SELECT * FROM Invoice WHERE DueDate < '{today}' AND Balance > '0'`\n- `GET /v3/company/{companyId}/reports/ProfitAndLoss?start_date={start}&end_date={end}`\n- Always set `Accept: application/json` and `Content-Type: application/json`\n\n### Google Sheets (http_request + google_workspace connector)\n- `POST /v4/spreadsheets/{id}/values/{range}:append?valueInputOption=USER_ENTERED` ‚Äî append rows\n- `PUT /v4/spreadsheets/{id}/values/{range}?valueInputOption=USER_ENTERED` ‚Äî update cells\n- `GET /v4/spreadsheets/{id}/values/{range}` ‚Äî read for deduplication\n\n### Gmail (gmail_send)\n- Payment reminders with HTML formatting\n- Subject format: `Payment Reminder: Invoice #{number}` (friendly) or `Overdue Notice: Invoice #{number}` (firm)\n- Always include invoice number, amount, due date, and payment instructions\n\n### Slack (http_request + slack connector)\n- `POST https://slack.com/api/chat.postMessage` with Block Kit payload\n- Channel: `#finance` for summaries, `#finance-alerts` for urgent anomalies\n\n### Local State (file_read / file_write)\n- `state/last_sync.json` ‚Äî sync timestamp tracking\n- `state/reminder_log.json` ‚Äî sent reminder history\n- `state/spending_baselines.json` ‚Äî 30-day rolling averages\n- `state/pending_sync.json` ‚Äî fallback for failed Sheet writes\n\n---\n\n## Error Handling\n\n- **401 Unauthorized (QuickBooks)**: Token expired ‚Äî notify user to re-authenticate. Do not update sync timestamp.\n- **429 Rate Limited**: Respect `Retry-After` headers. Batch queries where possible.\n- **5xx errors**: Retry up to 3 times with exponential backoff (5s, 15s, 45s). Alert on persistent failure.\n- **Gmail bounce**: Flag bounced addresses for `manual_review`.\n- **Sheet append failure**: Cache data in `state/pending_sync.json` for next-cycle retry.\n- **Data integrity**: Always deduplicate by invoice number before appending. Never delete historical rows.\n\n---\n\n## Communication Protocols\n\n- **user_message**: Anomalous transactions, API authentication failures, system errors\n- **agent_memory**: Spending pattern baselines, sync state, learned category mappings\n- **manual_review**: Severely overdue invoices (31+ days), large transactions exceeding review threshold, bounced email addresses\n\n---\n\n## Guardrails\n\n- Never send payment reminders for invoices less than 1 day overdue.\n- Never send more than one reminder per invoice within the cooldown window (3 days friendly, 5 days firm).\n- Never auto-email for invoices 31+ days overdue ‚Äî these require human judgment.\n- Never delete or overwrite historical financial data in Google Sheets.\n- Always verify invoice numbers exist in QuickBooks before sending reminders.\n- Cap anomaly alerts to 10 per day to avoid alert fatigue ‚Äî batch additional anomalies into a single summary.",
    "summary": "The Finance Controller is an autonomous financial operations agent that synchronizes QuickBooks invoices and expenses to Google Sheets on a daily schedule, proactively detects overdue invoices and sends tiered payment reminders via Gmail (friendly for 1-7 days, firm for 8-30 days, manual review for 31+), runs statistical anomaly detection on expenses by comparing against 30-day rolling category averages, and delivers formatted weekly cash flow summaries to Slack every Friday. It maintains local state files for sync tracking, reminder deduplication, and spending baselines, ensuring no duplicate reminders are sent and no data is lost between execution cycles.",
    "design_highlights": [
      {
        "category": "Financial Sync",
        "icon": "üìä",
        "color": "blue",
        "items": [
          "Daily QuickBooks ‚Üí Google Sheets sync with deduplication",
          "Tracks invoices, expenses, and dashboard totals",
          "Timestamp-based incremental sync prevents data gaps",
          "Fallback caching for failed Sheet writes"
        ]
      },
      {
        "category": "Collections Automation",
        "icon": "üì®",
        "color": "amber",
        "items": [
          "Three-tier overdue detection: friendly, firm, manual review",
          "Cooldown windows prevent reminder fatigue (3-day and 5-day)",
          "Automatic escalation from email to human review at 31 days",
          "Full reminder audit trail in local state"
        ]
      },
      {
        "category": "Anomaly Detection",
        "icon": "üîç",
        "color": "red",
        "items": [
          "Statistical flagging at 3x category average per transaction",
          "Category-level daily total monitoring at 2x threshold",
          "30-day rolling baseline with automatic updates",
          "Daily alert cap of 10 to prevent notification fatigue"
        ]
      },
      {
        "category": "Executive Reporting",
        "icon": "üìà",
        "color": "green",
        "items": [
          "Weekly cash flow summary with week-over-week trends",
          "AR aging breakdown across four time buckets",
          "Top 5 expense category analysis",
          "Rich Slack Block Kit formatting with dashboard links"
        ]
      }
    ],
    "suggested_connectors": [
      {
        "name": "quickbooks",
        "label": "QuickBooks Online",
        "auth_type": "oauth2",
        "credential_fields": [
          {
            "key": "client_id",
            "label": "Client ID",
            "type": "text",
            "placeholder": "ABc123...",
            "helpText": "From Intuit Developer Portal ‚Üí your app ‚Üí Keys & credentials",
            "required": true
          },
          {
            "key": "client_secret",
            "label": "Client Secret",
            "type": "password",
            "placeholder": "xxxxxxxxxxxxxxxx",
            "helpText": "From Intuit Developer Portal ‚Üí your app ‚Üí Keys & credentials",
            "required": true
          },
          {
            "key": "realm_id",
            "label": "Company ID (Realm ID)",
            "type": "text",
            "placeholder": "1234567890",
            "helpText": "Found in your QuickBooks URL: .intuit.com/app/homepage?companyId=XXXXXXXXXX",
            "required": true
          },
          {
            "key": "refresh_token",
            "label": "Refresh Token",
            "type": "password",
            "placeholder": "AB11234...",
            "helpText": "Obtained during OAuth2 authorization flow. Tokens refresh automatically.",
            "required": true
          }
        ],
        "setup_instructions": "1. Go to https://developer.intuit.com and sign in.\n2. Create a new app (or select existing) under 'My Apps'.\n3. Under 'Keys & credentials', copy the Client ID and Client Secret.\n4. Set the redirect URI to your OAuth callback URL.\n5. Use the OAuth 2.0 Playground or your app to authorize and obtain a refresh token.\n6. Find your Company ID (Realm ID) in the QuickBooks Online URL after logging in.\n7. Enter all values in the connector fields above.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          0,
          1,
          2
        ],
        "api_base_url": "https://quickbooks.api.intuit.com/v3"
      },
      {
        "name": "google_workspace",
        "label": "Google Workspace (Sheets + Gmail)",
        "auth_type": "oauth2",
        "credential_fields": [
          {
            "key": "client_id",
            "label": "Client ID",
            "type": "text",
            "placeholder": "xxxx.apps.googleusercontent.com",
            "helpText": "From Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials",
            "required": true
          },
          {
            "key": "client_secret",
            "label": "Client Secret",
            "type": "password",
            "placeholder": "GOCSPX-xxxxxxxx",
            "helpText": "From Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials",
            "required": true
          },
          {
            "key": "refresh_token",
            "label": "Refresh Token",
            "type": "password",
            "placeholder": "1//0xxxxxxxxx",
            "helpText": "Obtained during OAuth2 consent flow. Enable Gmail API and Sheets API in your project.",
            "required": true
          },
          {
            "key": "spreadsheet_id",
            "label": "Google Sheets Spreadsheet ID",
            "type": "text",
            "placeholder": "1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms",
            "helpText": "From the Google Sheets URL: docs.google.com/spreadsheets/d/{THIS_PART}/edit",
            "required": true
          }
        ],
        "setup_instructions": "1. Go to https://console.cloud.google.com and create or select a project.\n2. Enable the Gmail API and Google Sheets API under 'APIs & Services ‚Üí Library'.\n3. Create OAuth 2.0 credentials under 'APIs & Services ‚Üí Credentials'.\n4. Set the redirect URI and complete the consent screen setup.\n5. Authorize the app with scopes: gmail.send, gmail.readonly, spreadsheets.\n6. Create a Google Sheet with three tabs: 'Invoices', 'Expenses', 'Dashboard'.\n7. Copy the Spreadsheet ID from the Sheet URL and enter it above.",
        "related_tools": [
          "http_request",
          "gmail_send",
          "gmail_search"
        ],
        "related_triggers": [
          0,
          1
        ],
        "api_base_url": "https://www.googleapis.com"
      },
      {
        "name": "slack",
        "label": "Slack",
        "auth_type": "bot_token",
        "credential_fields": [
          {
            "key": "bot_token",
            "label": "Bot User OAuth Token",
            "type": "password",
            "placeholder": "xoxb-xxxxxxxxxxxx-xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx",
            "helpText": "From Slack App ‚Üí OAuth & Permissions ‚Üí Bot User OAuth Token. Requires chat:write scope.",
            "required": true
          },
          {
            "key": "finance_channel",
            "label": "Finance Channel ID",
            "type": "text",
            "placeholder": "C01ABCDEF23",
            "helpText": "Right-click the #finance channel ‚Üí 'View channel details' ‚Üí copy the Channel ID at the bottom.",
            "required": true
          },
          {
            "key": "alerts_channel",
            "label": "Alerts Channel ID",
            "type": "text",
            "placeholder": "C04XYZABC56",
            "helpText": "Channel for urgent anomaly alerts. Can be the same as Finance Channel if preferred.",
            "required": false
          }
        ],
        "setup_instructions": "1. Go to https://api.slack.com/apps and create a new app (or select existing).\n2. Under 'OAuth & Permissions', add these Bot Token Scopes: chat:write, chat:write.public.\n3. Install the app to your workspace and copy the Bot User OAuth Token.\n4. Create a #finance channel (and optionally #finance-alerts) in your Slack workspace.\n5. Invite the bot to the channel(s): type /invite @YourBotName in each channel.\n6. Get the Channel ID by right-clicking the channel ‚Üí 'View channel details' ‚Üí ID is at the bottom.",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          2
        ],
        "api_base_url": "https://slack.com/api"
      }
    ],
    "suggested_notification_channels": [
      {
        "type": "slack",
        "description": "Weekly cash flow summaries and urgent anomaly alerts posted to finance channels",
        "required_connector": "slack",
        "config_hints": {
          "channel": "#finance",
          "alerts_channel": "#finance-alerts"
        }
      },
      {
        "type": "email",
        "description": "Payment reminder emails sent directly to customers with overdue invoices via Gmail",
        "required_connector": "google_workspace",
        "config_hints": {
          "from_name": "Accounts Receivable"
        }
      }
    ],
    "suggested_event_subscriptions": [
      {
        "event_type": "user_message",
        "description": "Emitted when anomalous transactions are detected (expenses exceeding 3x category average) or when critical errors occur (API auth failures, persistent service outages). Alerts the user to review flagged items."
      },
      {
        "event_type": "agent_memory",
        "description": "Used to persist and retrieve 30-day spending pattern baselines across execution cycles. Updated after each daily sync to maintain accurate anomaly detection thresholds."
      },
      {
        "event_type": "manual_review",
        "description": "Triggered for severely overdue invoices (31+ days), unusually large transactions exceeding a configurable threshold, and bounced customer email addresses that need human intervention."
      }
    ],
    "use_case_flows": [
      {
        "id": "flow_daily_sync",
        "name": "Daily QuickBooks ‚Üí Google Sheets Sync",
        "description": "Pulls updated invoices and expenses from QuickBooks, syncs them to Google Sheets, and runs anomaly detection on new expenses.",
        "nodes": [
          {
            "id": "ds1",
            "type": "start",
            "label": "Daily 7AM schedule fires",
            "detail": "Cron trigger: 0 7 * * *"
          },
          {
            "id": "ds2",
            "type": "action",
            "label": "Read last sync timestamp",
            "detail": "file_read state/last_sync.json to get the timestamp of the last successful sync"
          },
          {
            "id": "ds3",
            "type": "connector",
            "label": "Query QuickBooks invoices",
            "detail": "GET /v3/company/{companyId}/query ‚Äî SELECT invoices updated since last sync timestamp",
            "connector": "quickbooks"
          },
          {
            "id": "ds4",
            "type": "connector",
            "label": "Query QuickBooks expenses",
            "detail": "GET /v3/company/{companyId}/query ‚Äî SELECT purchases from previous business day",
            "connector": "quickbooks"
          },
          {
            "id": "ds5",
            "type": "decision",
            "label": "New or updated data found?",
            "detail": "Check if invoice or expense query returned any results"
          },
          {
            "id": "ds6",
            "type": "connector",
            "label": "Read existing Sheet rows",
            "detail": "GET /v4/spreadsheets/{id}/values/Invoices ‚Äî read current invoice numbers for deduplication",
            "connector": "google_workspace"
          },
          {
            "id": "ds7",
            "type": "action",
            "label": "Deduplicate and transform",
            "detail": "Match new invoices against existing rows by invoice number; separate new rows from status updates"
          },
          {
            "id": "ds8",
            "type": "connector",
            "label": "Append/update Google Sheets",
            "detail": "POST .../values:append for new rows, PUT .../values for status updates on Invoices, Expenses, and Dashboard sheets",
            "connector": "google_workspace"
          },
          {
            "id": "ds9",
            "type": "action",
            "label": "Run anomaly detection",
            "detail": "Compare each new expense against 30-day rolling category averages from state/spending_baselines.json"
          },
          {
            "id": "ds10",
            "type": "decision",
            "label": "Anomalies detected?",
            "detail": "Check if any transaction exceeds 3x category average or any category exceeds 2x daily average"
          },
          {
            "id": "ds11",
            "type": "event",
            "label": "Emit anomaly alert",
            "detail": "Send user_message with flagged transaction details, amount, category, and statistical reasoning"
          },
          {
            "id": "ds12",
            "type": "action",
            "label": "Update baselines and sync timestamp",
            "detail": "Write updated rolling averages to state/spending_baselines.json and current timestamp to state/last_sync.json"
          },
          {
            "id": "ds13",
            "type": "error",
            "label": "Handle API failure",
            "detail": "Log error, cache pending data to state/pending_sync.json, do NOT update sync timestamp so retry occurs next cycle"
          },
          {
            "id": "ds14",
            "type": "end",
            "label": "Daily sync complete"
          }
        ],
        "edges": [
          {
            "id": "de1",
            "source": "ds1",
            "target": "ds2"
          },
          {
            "id": "de2",
            "source": "ds2",
            "target": "ds3"
          },
          {
            "id": "de3",
            "source": "ds3",
            "target": "ds4"
          },
          {
            "id": "de4",
            "source": "ds4",
            "target": "ds5"
          },
          {
            "id": "de5",
            "source": "ds5",
            "target": "ds6",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "de6",
            "source": "ds5",
            "target": "ds12",
            "label": "No data",
            "variant": "no"
          },
          {
            "id": "de7",
            "source": "ds6",
            "target": "ds7"
          },
          {
            "id": "de8",
            "source": "ds7",
            "target": "ds8"
          },
          {
            "id": "de9",
            "source": "ds8",
            "target": "ds9"
          },
          {
            "id": "de10",
            "source": "ds9",
            "target": "ds10"
          },
          {
            "id": "de11",
            "source": "ds10",
            "target": "ds11",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "de12",
            "source": "ds10",
            "target": "ds12",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "de13",
            "source": "ds11",
            "target": "ds12"
          },
          {
            "id": "de14",
            "source": "ds12",
            "target": "ds14"
          },
          {
            "id": "de15",
            "source": "ds3",
            "target": "ds13",
            "label": "API error",
            "variant": "error"
          },
          {
            "id": "de16",
            "source": "ds8",
            "target": "ds13",
            "label": "Sheets error",
            "variant": "error"
          },
          {
            "id": "de17",
            "source": "ds13",
            "target": "ds14",
            "variant": "error"
          }
        ]
      },
      {
        "id": "flow_overdue_reminders",
        "name": "Overdue Invoice Detection & Payment Reminders",
        "description": "Polls QuickBooks for overdue invoices, applies tiered reminder logic with cooldown windows, and sends appropriate follow-ups via Gmail or escalates to manual review.",
        "nodes": [
          {
            "id": "or1",
            "type": "start",
            "label": "Polling trigger fires",
            "detail": "Every 10 minutes during business hours: */10 8-18 * * 1-5"
          },
          {
            "id": "or2",
            "type": "connector",
            "label": "Query overdue invoices",
            "detail": "GET /v3/company/{companyId}/query ‚Äî SELECT invoices WHERE DueDate < today AND Balance > 0",
            "connector": "quickbooks"
          },
          {
            "id": "or3",
            "type": "decision",
            "label": "Overdue invoices found?",
            "detail": "Check if query returned any results with outstanding balances"
          },
          {
            "id": "or4",
            "type": "action",
            "label": "Load reminder history",
            "detail": "file_read state/reminder_log.json to check last reminder date and tier for each invoice"
          },
          {
            "id": "or5",
            "type": "decision",
            "label": "Classify overdue tier",
            "detail": "1-7 days = friendly (3-day cooldown), 8-30 days = firm (5-day cooldown), 31+ days = manual review"
          },
          {
            "id": "or6",
            "type": "action",
            "label": "Compose friendly reminder",
            "detail": "HTML email with invoice details, polite tone, payment instructions. Subject: 'Payment Reminder: Invoice #{number}'"
          },
          {
            "id": "or7",
            "type": "action",
            "label": "Compose firm follow-up",
            "detail": "HTML email with invoice details, firmer tone, urgency noted. Subject: 'Overdue Notice: Invoice #{number}'"
          },
          {
            "id": "or8",
            "type": "connector",
            "label": "Send reminder via Gmail",
            "detail": "gmail_send to customer email with HTML body, invoice number in subject for tracking",
            "connector": "google_workspace"
          },
          {
            "id": "or9",
            "type": "action",
            "label": "Log sent reminder",
            "detail": "file_write to state/reminder_log.json: invoice ID, recipient, timestamp, tier"
          },
          {
            "id": "or10",
            "type": "event",
            "label": "Flag for manual review",
            "detail": "Emit manual_review event for invoices 31+ days overdue with customer details, amount, and aging info"
          },
          {
            "id": "or11",
            "type": "error",
            "label": "Handle send failure",
            "detail": "Do NOT log to reminder_log.json so the reminder will be retried. If email bounced, flag for manual review."
          },
          {
            "id": "or12",
            "type": "end",
            "label": "Reminder cycle complete"
          }
        ],
        "edges": [
          {
            "id": "oe1",
            "source": "or1",
            "target": "or2"
          },
          {
            "id": "oe2",
            "source": "or2",
            "target": "or3"
          },
          {
            "id": "oe3",
            "source": "or3",
            "target": "or4",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "oe4",
            "source": "or3",
            "target": "or12",
            "label": "None found",
            "variant": "no"
          },
          {
            "id": "oe5",
            "source": "or4",
            "target": "or5"
          },
          {
            "id": "oe6",
            "source": "or5",
            "target": "or6",
            "label": "1-7 days",
            "variant": "yes"
          },
          {
            "id": "oe7",
            "source": "or5",
            "target": "or7",
            "label": "8-30 days",
            "variant": "no"
          },
          {
            "id": "oe8",
            "source": "or5",
            "target": "or10",
            "label": "31+ days"
          },
          {
            "id": "oe9",
            "source": "or6",
            "target": "or8"
          },
          {
            "id": "oe10",
            "source": "or7",
            "target": "or8"
          },
          {
            "id": "oe11",
            "source": "or8",
            "target": "or9"
          },
          {
            "id": "oe12",
            "source": "or9",
            "target": "or12"
          },
          {
            "id": "oe13",
            "source": "or10",
            "target": "or12"
          },
          {
            "id": "oe14",
            "source": "or8",
            "target": "or11",
            "label": "Send failed",
            "variant": "error"
          },
          {
            "id": "oe15",
            "source": "or11",
            "target": "or12",
            "variant": "error"
          }
        ]
      },
      {
        "id": "flow_weekly_summary",
        "name": "Weekly Cash Flow Summary to Slack",
        "description": "Aggregates weekly financial data from QuickBooks, calculates trends and AR aging, and posts a formatted Block Kit summary to Slack.",
        "nodes": [
          {
            "id": "ws1",
            "type": "start",
            "label": "Friday 5PM schedule fires",
            "detail": "Cron trigger: 0 17 * * 5"
          },
          {
            "id": "ws2",
            "type": "connector",
            "label": "Pull weekly P&L report",
            "detail": "GET /v3/company/{companyId}/reports/ProfitAndLoss for current week date range",
            "connector": "quickbooks"
          },
          {
            "id": "ws3",
            "type": "connector",
            "label": "Query AR aging data",
            "detail": "GET /v3/company/{companyId}/query ‚Äî SELECT invoices grouped by aging buckets (current, 1-30, 31-60, 60+)",
            "connector": "quickbooks"
          },
          {
            "id": "ws4",
            "type": "action",
            "label": "Load previous week baseline",
            "detail": "file_read state/weekly_summary.json to get last week's metrics for comparison"
          },
          {
            "id": "ws5",
            "type": "action",
            "label": "Calculate metrics and trends",
            "detail": "Compute total revenue, expenses, net cash flow, week-over-week % changes, top 5 expense categories"
          },
          {
            "id": "ws6",
            "type": "action",
            "label": "Format Block Kit message",
            "detail": "Build Slack Block Kit payload with sections for revenue, expenses, net flow, AR aging, trends with arrows"
          },
          {
            "id": "ws7",
            "type": "connector",
            "label": "Post summary to Slack",
            "detail": "POST https://slack.com/api/chat.postMessage with blocks payload to #finance channel",
            "connector": "slack"
          },
          {
            "id": "ws8",
            "type": "action",
            "label": "Save current week baseline",
            "detail": "file_write this week's metrics to state/weekly_summary.json for next week's comparison"
          },
          {
            "id": "ws9",
            "type": "error",
            "label": "Handle Slack post failure",
            "detail": "Cache summary to state/pending_slack.json for retry. If channel_not_found, emit user_message to reconfigure."
          },
          {
            "id": "ws10",
            "type": "end",
            "label": "Weekly summary complete"
          }
        ],
        "edges": [
          {
            "id": "we1",
            "source": "ws1",
            "target": "ws2"
          },
          {
            "id": "we2",
            "source": "ws2",
            "target": "ws3"
          },
          {
            "id": "we3",
            "source": "ws3",
            "target": "ws4"
          },
          {
            "id": "we4",
            "source": "ws4",
            "target": "ws5"
          },
          {
            "id": "we5",
            "source": "ws5",
            "target": "ws6"
          },
          {
            "id": "we6",
            "source": "ws6",
            "target": "ws7"
          },
          {
            "id": "we7",
            "source": "ws7",
            "target": "ws8"
          },
          {
            "id": "we8",
            "source": "ws8",
            "target": "ws10"
          },
          {
            "id": "we9",
            "source": "ws7",
            "target": "ws9",
            "label": "Post failed",
            "variant": "error"
          },
          {
            "id": "we10",
            "source": "ws9",
            "target": "ws10",
            "variant": "error"
          },
          {
            "id": "we11",
            "source": "ws2",
            "target": "ws9",
            "label": "QB error",
            "variant": "error"
          }
        ]
      }
    ],
    "customSections": [
      {
        "key": "data_model",
        "label": "Google Sheets Data Model",
        "content": "The target Google Sheet should have three tabs:\n\n**Invoices tab**: Invoice Number | Customer Name | Amount | Due Date | Status | Balance | Last Updated\n\n**Expenses tab**: Date | Vendor | Amount | Category | Payment Method | Sync Date\n\n**Dashboard tab**: Summary cells for Today's Invoices, Today's Expenses, Total AR Balance, Overdue Count, Week-to-Date Revenue, Week-to-Date Expenses"
      },
      {
        "key": "reminder_templates",
        "label": "Email Reminder Templates",
        "content": "**Friendly (1-7 days)**: Professional, warm tone. Acknowledges the invoice may have been overlooked. Includes invoice number, amount, original due date, and payment instructions.\n\n**Firm (8-30 days)**: Direct but respectful. Notes the specific number of days overdue. Requests prompt attention. Includes the same invoice details plus a note about potential service impact.\n\n**Manual Review Escalation**: Not emailed ‚Äî flagged internally with full context: customer name, invoice history, total outstanding balance, and recommended next steps."
      }
    ]
  }
}
