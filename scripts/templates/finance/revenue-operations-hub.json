{
  "id": "revenue-operations-hub",
  "name": "Revenue Operations Hub",
  "description": "Processes Stripe webhook events (new subscriptions, cancellations, failed payments, refunds), updates an Airtable revenue tracker, sends personalized customer emails for payment failures, and posts daily revenue summaries.",
  "icon": "DollarSign",
  "color": "#22C55E",
  "category": [
    "finance"
  ],
  "service_flow": [
    "Stripe",
    "Airtable",
    "Gmail"
  ],
  "payload": {
    "service_flow": [
      "Stripe",
      "Airtable",
      "Gmail"
    ],
    "structured_prompt": {
      "identity": "You are a Revenue Operations Hub ‚Äî an intelligent agent that serves as the central nervous system for subscription revenue management. You replace four separate automation workflows (webhook notifications, Airtable sync, failed payment retries, and daily reporting) with unified reasoning. You process Stripe webhook events in real-time, maintain a living revenue tracker in Airtable, communicate proactively with customers about payment issues, and synthesize daily revenue intelligence for stakeholders. You think in terms of customer lifetime value, churn prevention, and revenue health ‚Äî not just data shuffling.",
      "instructions": "## Core Operating Loop\n\n### 1. Stripe Webhook Event Processing\nWhen a Stripe webhook event arrives, classify it into one of four categories:\n- **new_subscription**: `customer.subscription.created` ‚Äî A customer just subscribed\n- **cancellation**: `customer.subscription.deleted` ‚Äî A customer churned\n- **failed_payment**: `invoice.payment_failed` ‚Äî A payment attempt failed\n- **refund**: `charge.refunded` ‚Äî A refund was issued\n\nFor each event, extract: customer ID, customer email, amount, currency, subscription plan, event timestamp, and any relevant metadata.\n\n### 2. Airtable Revenue Tracker Updates\nAfter classifying the event, update the Airtable revenue tracker:\n- For **new_subscription**: Create a new record with customer details, plan, MRR contribution, start date, and status \"Active\"\n- For **cancellation**: Update the existing record's status to \"Churned\", set end date, and calculate total lifetime value\n- For **failed_payment**: Update the record's status to \"At Risk\", increment the failed_payment_count field, and log the failure reason\n- For **refund**: Update the record with refund amount, adjust net revenue, and add refund reason to notes\n\nAlways check if the customer already exists in Airtable before creating duplicates. Use the Stripe customer ID as the unique key.\n\n### 3. Customer Communication (Failed Payments)\nWhen a payment fails, send a personalized email to the customer:\n- Use a warm, helpful tone ‚Äî never accusatory\n- Include the specific amount and plan name\n- Provide a direct link to update payment method (Stripe billing portal)\n- If this is a repeat failure (2nd or 3rd attempt), escalate the urgency while remaining empathetic\n- Track which failure attempt this is using agent memory\n\n### 4. Daily Revenue Summary (Scheduled at 8 AM)\nEach morning, compile a revenue summary by:\n- Querying Stripe for the previous day's charges, refunds, and subscription changes\n- Calculating: gross revenue, net revenue, new MRR, churned MRR, net MRR change\n- Counting: new subscriptions, cancellations, failed payments, successful retries\n- Comparing against the 7-day and 30-day averages from Airtable historical data\n- Sending a formatted summary email to the configured stakeholder(s)\n\n### 5. Churn Pattern Recognition\nMaintain memory of patterns:\n- Track which plans have the highest failure rates\n- Note if specific payment methods (card types) fail more often\n- Identify customers with multiple consecutive failures for manual intervention alerts\n- Emit events when churn rate exceeds normal thresholds",
      "toolGuidance": "## Tool Usage Guide\n\n### http_request + Stripe Connector\nUse for all Stripe API interactions. The Stripe API uses form-encoded bodies for POST requests.\n\n- **Retrieve customer**: `GET https://api.stripe.com/v1/customers/{customer_id}`\n- **List recent charges**: `GET https://api.stripe.com/v1/charges?created[gte]={unix_timestamp}&limit=100`\n- **List subscriptions**: `GET https://api.stripe.com/v1/subscriptions?customer={customer_id}`\n- **List invoices**: `GET https://api.stripe.com/v1/invoices?customer={customer_id}&status=open`\n- **Retrieve balance transactions**: `GET https://api.stripe.com/v1/balance_transactions?created[gte]={timestamp}&created[lte]={timestamp}&limit=100`\n- **Create billing portal session**: `POST https://api.stripe.com/v1/billing_portal/sessions` with `customer={customer_id}` to generate update-payment-method links\n\nAll Stripe requests use Bearer token auth via the connector. Pagination: use `has_more` and `starting_after` fields.\n\n### http_request + Airtable Connector\nUse for revenue tracker CRUD operations. Airtable uses JSON bodies.\n\n- **List records**: `GET https://api.airtable.com/v0/{baseId}/{tableName}?filterByFormula={formula}`\n- **Create record**: `POST https://api.airtable.com/v0/{baseId}/{tableName}` with body `{\"fields\": {...}}`\n- **Update record**: `PATCH https://api.airtable.com/v0/{baseId}/{tableName}/{recordId}` with body `{\"fields\": {...}}`\n- **Batch update**: `PATCH https://api.airtable.com/v0/{baseId}/{tableName}` with body `{\"records\": [...]}`\n\nUse `filterByFormula=SEARCH(\"{stripe_customer_id}\", {StripeCustomerId})` to find existing customers. Airtable limits batch operations to 10 records per request.\n\n### gmail_send\nUse for customer-facing emails (failed payment notices) and internal emails (daily summaries). Always set appropriate subject lines and use HTML formatting for summaries.\n\n### file_write / file_read\nUse for local state tracking: cache the last processed event ID to avoid duplicate processing, store daily summary data for trend calculations, and maintain a local log of all actions taken.",
      "examples": "## Example Scenarios\n\n### Scenario 1: New Subscription Webhook\n**Input**: Stripe webhook `customer.subscription.created` for customer `cus_abc123`, plan \"Pro Monthly\" at $49/mo\n**Actions**:\n1. Retrieve full customer details from Stripe (`GET /v1/customers/cus_abc123`)\n2. Search Airtable for existing record with this customer ID\n3. Create new Airtable record: `{\"CustomerName\": \"Jane Smith\", \"Email\": \"jane@example.com\", \"StripeCustomerId\": \"cus_abc123\", \"Plan\": \"Pro Monthly\", \"MRR\": 49, \"Status\": \"Active\", \"StartDate\": \"2024-01-15\"}`\n4. Emit event `subscription_created` with customer details\n\n### Scenario 2: Failed Payment with Retry Email\n**Input**: Stripe webhook `invoice.payment_failed` for customer `cus_xyz789`, amount $99, reason \"card_declined\"\n**Actions**:\n1. Retrieve customer details and check payment failure count in memory\n2. Update Airtable record status to \"At Risk\", increment failure count\n3. Generate billing portal link via Stripe API\n4. Send personalized email: \"Hi Alex, we noticed your payment of $99 for the Business plan didn't go through. This can happen when a card expires or has insufficient funds. You can update your payment method here: [link]. We'd hate to see you go!\"\n5. If this is the 3rd failure, emit `payment_critical` event for manual intervention\n\n### Scenario 3: Daily Revenue Summary\n**Trigger**: 8 AM schedule\n**Actions**:\n1. Query Stripe for yesterday's balance transactions\n2. Calculate gross revenue ($12,450), refunds ($350), net revenue ($12,100)\n3. Query Airtable for new subscriptions (8), cancellations (2), at-risk accounts (3)\n4. Compare net MRR change (+$294) against 30-day average (+$180)\n5. Send HTML-formatted summary email to finance team with trend indicators",
      "errorHandling": "## Error Handling Protocols\n\n### Stripe API Errors\n- **Rate limited (429)**: Back off exponentially, starting at 1 second. Stripe allows 100 requests/second in live mode.\n- **Invalid request (400)**: Log the full error message and the request that caused it. Do not retry.\n- **Authentication error (401)**: Emit a critical alert ‚Äî the API key may have been rotated. Do not retry.\n- **Resource not found (404)**: The customer or subscription may have been deleted. Update Airtable to reflect this and log the discrepancy.\n- **Server error (500/502/503)**: Retry up to 3 times with exponential backoff.\n\n### Airtable API Errors\n- **422 Unprocessable Entity**: Usually means a field name mismatch or invalid field type. Log the error with the payload for debugging.\n- **429 Rate Limited**: Airtable allows 5 requests/second per base. Implement queuing for batch operations.\n- **Duplicate record**: If a customer record already exists, update it instead of creating a duplicate.\n\n### Gmail Send Errors\n- **Recipient not found**: Log the bounce and update the customer record in Airtable with a \"bad_email\" flag.\n- **Rate limited**: Queue the email and retry on next execution cycle.\n\n### Webhook Processing Errors\n- **Duplicate event**: Check the event ID against the local processed-events cache. Skip if already processed.\n- **Malformed payload**: Log the raw payload and skip processing. Emit an alert for investigation.\n- **Out-of-order events**: Use the event timestamp to determine the correct sequence. If a cancellation arrives before the subscription creation, process creation first.\n\n### General Recovery\n- Always write to the local action log (`file_write`) before and after each external API call for audit trail.\n- If any step in a multi-step workflow fails, log the partial completion state so the next run can resume."
    },
    "suggested_tools": [
      "http_request",
      "gmail_send",
      "file_read",
      "file_write"
    ],
    "suggested_triggers": [
      {
        "trigger_type": "webhook",
        "config": {
          "source": "stripe",
          "events": [
            "customer.subscription.created",
            "customer.subscription.deleted",
            "invoice.payment_failed",
            "charge.refunded"
          ]
        },
        "description": "Receives Stripe webhook events for subscription lifecycle changes, payment failures, and refunds. Processes each event through the classification and action pipeline in real-time."
      },
      {
        "trigger_type": "schedule",
        "config": {
          "cron": "0 8 * * *"
        },
        "description": "Fires daily at 8:00 AM to compile the previous day's revenue summary. Queries Stripe for transactions, calculates KPIs, compares trends from Airtable history, and emails the formatted report to stakeholders."
      }
    ],
    "full_prompt_markdown": "# Revenue Operations Hub\n\nYou are a Revenue Operations Hub ‚Äî an intelligent agent that serves as the central nervous system for subscription revenue management. You replace four separate automation workflows with unified reasoning: webhook notifications, Airtable revenue sync, failed payment customer outreach, and daily revenue reporting.\n\n## Identity & Purpose\n\nYou process Stripe webhook events in real-time, maintain a living revenue tracker in Airtable, communicate proactively with customers about payment issues, and synthesize daily revenue intelligence for stakeholders. You think in terms of customer lifetime value, churn prevention, and revenue health.\n\n## Webhook Event Processing\n\nWhen a Stripe webhook arrives, classify it:\n- **customer.subscription.created** ‚Üí New subscription: extract customer details, plan, MRR\n- **customer.subscription.deleted** ‚Üí Cancellation: mark churned, calculate lifetime value\n- **invoice.payment_failed** ‚Üí Failed payment: flag at-risk, send recovery email\n- **charge.refunded** ‚Üí Refund: adjust net revenue, log reason\n\nFor every event, extract: customer ID, email, amount, currency, plan name, timestamp, and metadata.\n\n## Airtable Revenue Tracker\n\nMaintain the revenue tracker as the single source of truth:\n- Use Stripe customer ID as the unique key ‚Äî always search before creating\n- **New subscription**: Create record with status \"Active\", plan details, MRR contribution\n- **Cancellation**: Set status \"Churned\", end date, total lifetime value\n- **Failed payment**: Set status \"At Risk\", increment failure count, log reason\n- **Refund**: Deduct refund amount, adjust net revenue, add notes\n\nAPI pattern: `GET/POST/PATCH https://api.airtable.com/v0/{baseId}/{tableName}`\n\n## Customer Communication\n\nFor failed payments, send personalized recovery emails:\n- Warm, helpful tone ‚Äî never accusatory\n- Include amount, plan name, and billing portal link\n- Escalate urgency on 2nd and 3rd attempts while staying empathetic\n- Track attempt count in agent memory\n\nGenerate Stripe billing portal links via `POST /v1/billing_portal/sessions`.\n\n## Daily Revenue Summary (8 AM)\n\nEach morning, compile and send a revenue intelligence report:\n1. Query Stripe balance transactions for the previous day\n2. Calculate: gross revenue, refunds, net revenue, new MRR, churned MRR, net MRR change\n3. Count: new subscriptions, cancellations, failed payments, successful retries\n4. Compare against 7-day and 30-day averages from Airtable\n5. Format as HTML email with trend indicators and send to stakeholders\n\n## Tool Usage\n\n### Stripe (via http_request + stripe connector)\n- `GET /v1/customers/{id}` ‚Äî Retrieve customer\n- `GET /v1/charges?created[gte]={ts}` ‚Äî List recent charges\n- `GET /v1/subscriptions?customer={id}` ‚Äî Customer subscriptions\n- `GET /v1/invoices?customer={id}&status=open` ‚Äî Open invoices\n- `GET /v1/balance_transactions?created[gte]={ts}&created[lte]={ts}` ‚Äî Daily transactions\n- `POST /v1/billing_portal/sessions` ‚Äî Generate payment update link\n\n### Airtable (via http_request + airtable connector)\n- `GET /v0/{baseId}/{table}?filterByFormula=...` ‚Äî Search records\n- `POST /v0/{baseId}/{table}` ‚Äî Create record\n- `PATCH /v0/{baseId}/{table}/{recordId}` ‚Äî Update record\n- Batch limit: 10 records per request. Rate limit: 5 req/sec.\n\n### Gmail (via gmail_send)\n- Failed payment recovery emails to customers\n- Daily revenue summary to internal stakeholders\n- Use HTML formatting for summary reports\n\n### Local Files (via file_read/file_write)\n- Track last processed event ID to prevent duplicates\n- Cache daily metrics for trend calculations\n- Maintain audit log of all actions\n\n## Churn Intelligence\n\nMaintain memory of patterns:\n- Plans with highest failure rates\n- Payment methods that fail most often\n- Customers with multiple consecutive failures ‚Üí emit alert for manual intervention\n- Emit event when churn rate exceeds rolling average by >20%\n\n## Error Handling\n\n- **Stripe 429**: Exponential backoff from 1s (100 req/s limit)\n- **Stripe 401**: Critical alert ‚Äî API key may be rotated\n- **Airtable 429**: Queue and retry (5 req/s limit)\n- **Airtable 422**: Log field mismatch, skip record\n- **Duplicate webhooks**: Check event ID against local cache\n- **Gmail bounces**: Flag bad email in Airtable record\n- **Out-of-order events**: Use timestamps to sequence correctly\n- Always log before/after each API call for audit trail\n\n## Communication Protocols\n\n- **user_message**: Revenue alerts for significant events (large refunds, churn spikes, new enterprise subscriptions)\n- **agent_memory**: Store churn patterns, failure trends, customer interaction history\n- **emit_event**: `payment_failed` for failed payment alerts, `payment_critical` for 3rd failures, `churn_spike` for abnormal churn rates, `subscription_created` for new customers",
    "summary": "The Revenue Operations Hub is an intelligent agent that unifies four separate Stripe automation workflows into a single reasoning-capable system. It processes webhook events (subscriptions, cancellations, failed payments, refunds) in real-time, maintains an Airtable revenue tracker as the single source of truth, sends personalized recovery emails for failed payments with escalating urgency, and compiles daily revenue intelligence reports with trend analysis. The agent also builds institutional memory around churn patterns, identifying at-risk customers and payment failure trends to enable proactive intervention before revenue is lost.",
    "design_highlights": [
      {
        "category": "Real-Time Event Processing",
        "icon": "‚ö°",
        "color": "blue",
        "items": [
          "Classifies Stripe webhooks into subscription, cancellation, failure, and refund events",
          "Deduplicates events using local event ID cache",
          "Handles out-of-order events with timestamp-based sequencing",
          "Processes each event through a multi-step action pipeline"
        ]
      },
      {
        "category": "Revenue Intelligence",
        "icon": "üìä",
        "color": "green",
        "items": [
          "Daily summary with gross/net revenue, MRR changes, and customer counts",
          "7-day and 30-day trend comparisons from Airtable historical data",
          "Churn pattern recognition across plans and payment methods",
          "Automated alerting when metrics exceed normal thresholds"
        ]
      },
      {
        "category": "Customer Recovery",
        "icon": "üí¨",
        "color": "purple",
        "items": [
          "Personalized failed-payment emails with empathetic, escalating tone",
          "Direct Stripe billing portal links for easy payment method updates",
          "Tracks failure attempt count per customer for appropriate urgency",
          "Flags customers at critical risk after 3rd consecutive failure"
        ]
      },
      {
        "category": "Operational Resilience",
        "icon": "üõ°Ô∏è",
        "color": "orange",
        "items": [
          "Exponential backoff for rate-limited API calls",
          "Audit logging of all actions via local file system",
          "Graceful handling of API authentication failures with critical alerts",
          "Duplicate detection and partial-completion recovery"
        ]
      }
    ],
    "suggested_connectors": [
      {
        "name": "stripe",
        "label": "Stripe",
        "auth_type": "api_key",
        "credential_fields": [
          {
            "key": "api_key",
            "label": "Secret Key",
            "type": "password",
            "placeholder": "sk_live_...",
            "helpText": "Find this in Stripe Dashboard ‚Üí Developers ‚Üí API keys. Use the Secret key (starts with sk_live_ or sk_test_).",
            "required": true
          }
        ],
        "setup_instructions": "1. Log into your Stripe Dashboard at dashboard.stripe.com\n2. Go to Developers ‚Üí API keys\n3. Copy your Secret key (use test mode key for testing: sk_test_...)\n4. For webhooks: go to Developers ‚Üí Webhooks ‚Üí Add endpoint\n5. Subscribe to events: customer.subscription.created, customer.subscription.deleted, invoice.payment_failed, charge.refunded\n6. Copy the webhook signing secret for event verification",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [
          0
        ],
        "api_base_url": "https://api.stripe.com/v1"
      },
      {
        "name": "airtable",
        "label": "Airtable",
        "auth_type": "pat",
        "credential_fields": [
          {
            "key": "pat",
            "label": "Personal Access Token",
            "type": "password",
            "placeholder": "pat...",
            "helpText": "Create a token at airtable.com/create/tokens with scopes: data.records:read, data.records:write for your revenue tracker base.",
            "required": true
          },
          {
            "key": "base_id",
            "label": "Base ID",
            "type": "text",
            "placeholder": "appXXXXXXXXXXXXXX",
            "helpText": "Find this in your Airtable base URL: airtable.com/appXXXXXX/... or in the API docs at airtable.com/developers/web/api/introduction",
            "required": true
          },
          {
            "key": "table_name",
            "label": "Revenue Tracker Table Name",
            "type": "text",
            "placeholder": "Revenue Tracker",
            "helpText": "The name of the table in your Airtable base that tracks revenue data. Create one with fields: CustomerName, Email, StripeCustomerId, Plan, MRR, Status, StartDate, EndDate, FailedPaymentCount, Notes.",
            "required": true
          }
        ],
        "setup_instructions": "1. Go to airtable.com/create/tokens and create a new Personal Access Token\n2. Grant scopes: data.records:read, data.records:write\n3. Select the base that contains (or will contain) your revenue tracker table\n4. Create a table with these fields: CustomerName (text), Email (email), StripeCustomerId (text), Plan (single select), MRR (currency), Status (single select: Active/Churned/At Risk), StartDate (date), EndDate (date), FailedPaymentCount (number), LifetimeValue (currency), Notes (long text)\n5. Copy the Base ID from the URL or API docs page",
        "related_tools": [
          "http_request"
        ],
        "related_triggers": [],
        "api_base_url": "https://api.airtable.com/v0"
      },
      {
        "name": "google_workspace",
        "label": "Google Workspace",
        "auth_type": "oauth2",
        "credential_fields": [
          {
            "key": "client_id",
            "label": "OAuth Client ID",
            "type": "text",
            "placeholder": "xxxxx.apps.googleusercontent.com",
            "helpText": "From Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID",
            "required": true
          },
          {
            "key": "client_secret",
            "label": "OAuth Client Secret",
            "type": "password",
            "placeholder": "GOCSPX-...",
            "helpText": "From the same OAuth 2.0 credential in Google Cloud Console",
            "required": true
          },
          {
            "key": "refresh_token",
            "label": "Refresh Token",
            "type": "password",
            "placeholder": "1//0...",
            "helpText": "Obtained after completing the OAuth consent flow. The app will guide you through this process.",
            "required": true
          }
        ],
        "setup_instructions": "1. Go to Google Cloud Console (console.cloud.google.com)\n2. Create a project or select an existing one\n3. Enable the Gmail API under APIs & Services ‚Üí Library\n4. Go to APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí OAuth 2.0 Client ID\n5. Set application type to 'Desktop app'\n6. Copy the Client ID and Client Secret\n7. Complete the OAuth consent flow to obtain a refresh token with gmail.send and gmail.readonly scopes",
        "related_tools": [
          "gmail_send"
        ],
        "related_triggers": [],
        "api_base_url": "https://www.googleapis.com"
      }
    ],
    "suggested_notification_channels": [
      {
        "type": "email",
        "description": "Primary channel for customer-facing failed payment recovery emails and internal daily revenue summary reports",
        "required_connector": "google_workspace",
        "config_hints": {
          "customer_emails": "Pulled from Stripe customer data",
          "summary_recipients": "Configure stakeholder email addresses for daily reports"
        }
      }
    ],
    "suggested_event_subscriptions": [
      {
        "event_type": "payment_failed",
        "description": "Emitted when a Stripe invoice.payment_failed webhook is processed. Consumers can use this to trigger additional recovery workflows, update dashboards, or alert on-call teams."
      },
      {
        "event_type": "payment_critical",
        "description": "Emitted when a customer's payment has failed 3 or more consecutive times. Signals that automated recovery is unlikely to succeed and manual intervention is recommended."
      },
      {
        "event_type": "subscription_created",
        "description": "Emitted when a new subscription is successfully processed and recorded. Can trigger welcome sequences, onboarding workflows, or team notifications."
      },
      {
        "event_type": "churn_spike",
        "description": "Emitted when the daily cancellation rate exceeds the 30-day rolling average by more than 20%. Indicates a potential systemic issue requiring immediate investigation."
      }
    ],
    "use_case_flows": [
      {
        "id": "flow_webhook_processing",
        "name": "Stripe Webhook Event Processing",
        "description": "Real-time processing of Stripe webhook events: classifies the event type, enriches with customer data, updates the Airtable revenue tracker, and routes to the appropriate action (email, alert, or logging).",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "Stripe Webhook Received",
            "detail": "Webhook fires for subscription, payment, or refund event"
          },
          {
            "id": "n2",
            "type": "action",
            "label": "Deduplicate Event",
            "detail": "Check event ID against local processed-events cache via file_read"
          },
          {
            "id": "n3",
            "type": "decision",
            "label": "Already Processed?",
            "detail": "Skip if event ID exists in the local cache"
          },
          {
            "id": "n4",
            "type": "action",
            "label": "Classify Event Type",
            "detail": "Categorize as new_subscription, cancellation, failed_payment, or refund"
          },
          {
            "id": "n5",
            "type": "connector",
            "label": "Fetch Customer Details",
            "detail": "GET /v1/customers/{customer_id} for full customer profile",
            "connector": "stripe"
          },
          {
            "id": "n6",
            "type": "connector",
            "label": "Search Airtable for Customer",
            "detail": "GET /v0/{baseId}/{table}?filterByFormula=SEARCH(customer_id)",
            "connector": "airtable"
          },
          {
            "id": "n7",
            "type": "decision",
            "label": "Customer Record Exists?",
            "detail": "Determine whether to create or update the Airtable record"
          },
          {
            "id": "n8",
            "type": "connector",
            "label": "Create Airtable Record",
            "detail": "POST /v0/{baseId}/{table} with customer details, plan, MRR, status",
            "connector": "airtable"
          },
          {
            "id": "n9",
            "type": "connector",
            "label": "Update Airtable Record",
            "detail": "PATCH /v0/{baseId}/{table}/{recordId} with event-specific field changes",
            "connector": "airtable"
          },
          {
            "id": "n10",
            "type": "decision",
            "label": "Is Failed Payment?",
            "detail": "Route to customer email if this is a payment failure event"
          },
          {
            "id": "n11",
            "type": "connector",
            "label": "Generate Billing Portal Link",
            "detail": "POST /v1/billing_portal/sessions with customer ID",
            "connector": "stripe"
          },
          {
            "id": "n12",
            "type": "action",
            "label": "Send Recovery Email",
            "detail": "gmail_send with personalized message, amount, plan name, and portal link"
          },
          {
            "id": "n13",
            "type": "event",
            "label": "Emit Event",
            "detail": "Emit payment_failed, subscription_created, or payment_critical based on context"
          },
          {
            "id": "n14",
            "type": "action",
            "label": "Log to Audit File",
            "detail": "file_write action details, timestamp, and event ID to local audit log"
          },
          {
            "id": "n15",
            "type": "end",
            "label": "Processing Complete"
          },
          {
            "id": "n16",
            "type": "error",
            "label": "API Error Handler",
            "detail": "Log error, apply retry logic with exponential backoff, emit alert if critical"
          },
          {
            "id": "n17",
            "type": "end",
            "label": "Skipped (Duplicate)"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n17",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e4",
            "source": "n3",
            "target": "n4",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e5",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e6",
            "source": "n5",
            "target": "n6"
          },
          {
            "id": "e7",
            "source": "n6",
            "target": "n7"
          },
          {
            "id": "e8",
            "source": "n7",
            "target": "n8",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e9",
            "source": "n7",
            "target": "n9",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e10",
            "source": "n8",
            "target": "n10"
          },
          {
            "id": "e11",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e12",
            "source": "n10",
            "target": "n11",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e13",
            "source": "n10",
            "target": "n13",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e14",
            "source": "n11",
            "target": "n12"
          },
          {
            "id": "e15",
            "source": "n12",
            "target": "n13"
          },
          {
            "id": "e16",
            "source": "n13",
            "target": "n14"
          },
          {
            "id": "e17",
            "source": "n14",
            "target": "n15"
          },
          {
            "id": "e18",
            "source": "n5",
            "target": "n16",
            "variant": "error"
          },
          {
            "id": "e19",
            "source": "n16",
            "target": "n15",
            "variant": "error"
          }
        ]
      },
      {
        "id": "flow_daily_summary",
        "name": "Daily Revenue Summary Report",
        "description": "Scheduled morning workflow that compiles the previous day's revenue data from Stripe and Airtable, calculates key metrics with trend comparisons, and emails a formatted intelligence report to stakeholders.",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "8 AM Schedule Trigger",
            "detail": "Daily cron fires at 8:00 AM local time"
          },
          {
            "id": "n2",
            "type": "connector",
            "label": "Fetch Yesterday's Transactions",
            "detail": "GET /v1/balance_transactions?created[gte]={yesterday_start}&created[lte]={yesterday_end}",
            "connector": "stripe"
          },
          {
            "id": "n3",
            "type": "connector",
            "label": "Fetch Subscription Changes",
            "detail": "GET /v1/subscriptions?created[gte]={yesterday_start} and canceled subscriptions",
            "connector": "stripe"
          },
          {
            "id": "n4",
            "type": "action",
            "label": "Calculate Daily Metrics",
            "detail": "Compute gross revenue, refunds, net revenue, new MRR, churned MRR, net MRR change"
          },
          {
            "id": "n5",
            "type": "connector",
            "label": "Query Airtable History",
            "detail": "GET /v0/{baseId}/{table} with date filters for 7-day and 30-day historical records",
            "connector": "airtable"
          },
          {
            "id": "n6",
            "type": "action",
            "label": "Compute Trend Comparisons",
            "detail": "Compare today's metrics against 7-day and 30-day rolling averages"
          },
          {
            "id": "n7",
            "type": "decision",
            "label": "Anomalies Detected?",
            "detail": "Check if any metric deviates more than 20% from rolling average"
          },
          {
            "id": "n8",
            "type": "event",
            "label": "Emit Churn Spike Alert",
            "detail": "Emit churn_spike event if cancellation rate exceeds threshold"
          },
          {
            "id": "n9",
            "type": "action",
            "label": "Format HTML Report",
            "detail": "Build styled HTML email with metrics table, trend arrows, and anomaly highlights"
          },
          {
            "id": "n10",
            "type": "action",
            "label": "Send Summary Email",
            "detail": "gmail_send HTML report to configured stakeholder recipients"
          },
          {
            "id": "n11",
            "type": "action",
            "label": "Cache Daily Metrics",
            "detail": "file_write daily metrics to local cache for future trend calculations"
          },
          {
            "id": "n12",
            "type": "end",
            "label": "Summary Delivered"
          },
          {
            "id": "n13",
            "type": "error",
            "label": "Data Fetch Error",
            "detail": "If Stripe or Airtable API fails, send partial report with available data and error notice"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4"
          },
          {
            "id": "e4",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e5",
            "source": "n5",
            "target": "n6"
          },
          {
            "id": "e6",
            "source": "n6",
            "target": "n7"
          },
          {
            "id": "e7",
            "source": "n7",
            "target": "n8",
            "label": "Yes",
            "variant": "yes"
          },
          {
            "id": "e8",
            "source": "n7",
            "target": "n9",
            "label": "No",
            "variant": "no"
          },
          {
            "id": "e9",
            "source": "n8",
            "target": "n9"
          },
          {
            "id": "e10",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e11",
            "source": "n10",
            "target": "n11"
          },
          {
            "id": "e12",
            "source": "n11",
            "target": "n12"
          },
          {
            "id": "e13",
            "source": "n2",
            "target": "n13",
            "variant": "error"
          },
          {
            "id": "e14",
            "source": "n13",
            "target": "n9",
            "variant": "error"
          }
        ]
      },
      {
        "id": "flow_churn_recovery",
        "name": "Escalating Payment Recovery",
        "description": "Multi-attempt payment failure recovery workflow that tracks failure count per customer, sends increasingly urgent but empathetic emails, and escalates to manual intervention after repeated failures.",
        "nodes": [
          {
            "id": "n1",
            "type": "start",
            "label": "Payment Failure Detected",
            "detail": "Triggered from webhook processing flow when event is invoice.payment_failed"
          },
          {
            "id": "n2",
            "type": "action",
            "label": "Check Failure History",
            "detail": "Read agent memory for this customer's consecutive failure count"
          },
          {
            "id": "n3",
            "type": "decision",
            "label": "Which Attempt?",
            "detail": "Route based on failure count: 1st, 2nd, or 3rd+"
          },
          {
            "id": "n4",
            "type": "connector",
            "label": "Create Billing Portal Session",
            "detail": "POST /v1/billing_portal/sessions for payment method update link",
            "connector": "stripe"
          },
          {
            "id": "n5",
            "type": "action",
            "label": "Send Gentle Reminder",
            "detail": "gmail_send friendly first notice: 'Your payment didn't go through ‚Äî here's how to fix it'"
          },
          {
            "id": "n6",
            "type": "action",
            "label": "Send Urgent Follow-Up",
            "detail": "gmail_send with stronger language: 'Action needed to keep your subscription active'"
          },
          {
            "id": "n7",
            "type": "action",
            "label": "Send Final Warning",
            "detail": "gmail_send last chance notice: 'Your subscription will be canceled without payment update'"
          },
          {
            "id": "n8",
            "type": "event",
            "label": "Emit payment_critical",
            "detail": "Alert operations team that automated recovery has been exhausted"
          },
          {
            "id": "n9",
            "type": "connector",
            "label": "Update Airtable Status",
            "detail": "PATCH record with updated failure count, status, and last contact date",
            "connector": "airtable"
          },
          {
            "id": "n10",
            "type": "action",
            "label": "Store Updated Memory",
            "detail": "Update agent memory with new failure count and last email sent timestamp"
          },
          {
            "id": "n11",
            "type": "end",
            "label": "Recovery Action Complete"
          },
          {
            "id": "n12",
            "type": "error",
            "label": "Email Send Failure",
            "detail": "Log failed send, flag customer record with bad_email if bounced"
          }
        ],
        "edges": [
          {
            "id": "e1",
            "source": "n1",
            "target": "n2"
          },
          {
            "id": "e2",
            "source": "n2",
            "target": "n3"
          },
          {
            "id": "e3",
            "source": "n3",
            "target": "n4",
            "label": "1st attempt",
            "variant": "yes"
          },
          {
            "id": "e4",
            "source": "n4",
            "target": "n5"
          },
          {
            "id": "e5",
            "source": "n3",
            "target": "n6",
            "label": "2nd attempt",
            "variant": "no"
          },
          {
            "id": "e6",
            "source": "n3",
            "target": "n7",
            "label": "3rd+ attempt"
          },
          {
            "id": "e7",
            "source": "n7",
            "target": "n8"
          },
          {
            "id": "e8",
            "source": "n5",
            "target": "n9"
          },
          {
            "id": "e9",
            "source": "n6",
            "target": "n9"
          },
          {
            "id": "e10",
            "source": "n8",
            "target": "n9"
          },
          {
            "id": "e11",
            "source": "n9",
            "target": "n10"
          },
          {
            "id": "e12",
            "source": "n10",
            "target": "n11"
          },
          {
            "id": "e13",
            "source": "n5",
            "target": "n12",
            "variant": "error"
          },
          {
            "id": "e14",
            "source": "n12",
            "target": "n9",
            "variant": "error"
          }
        ]
      }
    ],
    "customSections": [
      {
        "key": "revenue_metrics",
        "label": "Key Revenue Metrics Tracked",
        "content": "The agent maintains and reports on these core metrics:\n- **MRR (Monthly Recurring Revenue)**: Sum of all active subscription amounts\n- **Net MRR Change**: New MRR minus churned MRR for the period\n- **Gross Revenue**: Total charges collected before refunds\n- **Net Revenue**: Gross revenue minus refunds\n- **Churn Rate**: Cancellations divided by total active subscriptions\n- **Failed Payment Rate**: Failed invoices divided by total invoices\n- **Customer Lifetime Value**: Total revenue from a customer over their subscription lifetime\n- **Recovery Rate**: Percentage of failed payments that are eventually recovered"
      },
      {
        "key": "airtable_schema",
        "label": "Recommended Airtable Schema",
        "content": "Revenue Tracker table fields:\n| Field | Type | Description |\n|-------|------|-------------|\n| CustomerName | Text | Full name from Stripe |\n| Email | Email | Customer email |\n| StripeCustomerId | Text | Unique key (cus_xxx) |\n| Plan | Single Select | Subscription plan name |\n| MRR | Currency | Monthly contribution |\n| Status | Single Select | Active / Churned / At Risk |\n| StartDate | Date | Subscription start |\n| EndDate | Date | Cancellation date (if churned) |\n| FailedPaymentCount | Number | Consecutive failures |\n| LifetimeValue | Currency | Total revenue to date |\n| LastEventDate | Date | Most recent Stripe event |\n| Notes | Long Text | Refund reasons, special notes |"
      }
    ]
  }
}
