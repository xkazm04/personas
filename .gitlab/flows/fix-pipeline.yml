# GitLab Duo Flow: Auto-fix failed pipelines
# Trigger: Pipeline failure on any branch
# Agent: gitlab-duo
# Action: Analyze failure logs, identify root cause, suggest or auto-create fix MR

name: Fix Pipeline Failures
description: >
  Automatically analyzes pipeline failures, identifies the root cause from job logs,
  and either suggests a fix or creates a merge request with the correction.

on:
  pipeline_failed:
    branches:
      - "*"

agent: gitlab-duo

steps:
  - name: Collect failure context
    action: read_pipeline_logs
    params:
      include_artifacts: true
      max_lines_per_job: 200

  - name: Identify root cause
    action: analyze
    prompt: |
      Analyze the following pipeline failure logs and identify:
      1. Which job(s) failed
      2. The root cause of each failure
      3. Whether it's a code issue, dependency issue, flaky test, or infrastructure problem

      Classify severity: critical (blocks release), moderate (blocks MR), low (flaky/transient).

      Pipeline logs:
      {{ steps.collect_failure_context.output }}

  - name: Generate fix
    action: code_suggestion
    when: "{{ steps.identify_root_cause.output.severity != 'low' }}"
    prompt: |
      Based on this root cause analysis, generate a minimal code fix:

      {{ steps.identify_root_cause.output }}

      Rules:
      - Only modify files directly related to the failure
      - Prefer the simplest correct fix
      - Include a clear commit message explaining what was wrong and why this fixes it

  - name: Create fix MR
    action: create_merge_request
    when: "{{ steps.generate_fix.output != null }}"
    params:
      title: "fix: auto-repair pipeline failure in {{ failed_job_name }}"
      description: |
        ## Automated Pipeline Fix

        **Failed job:** {{ steps.collect_failure_context.output.failed_job }}
        **Root cause:** {{ steps.identify_root_cause.output.summary }}

        {{ steps.generate_fix.output.explanation }}

        ---
        *Auto-generated by GitLab Duo Flow â€” `fix-pipeline.yml`*
      labels:
        - "bot:auto-fix"
        - "pipeline:repair"
