# GitLab Duo Flow: Security review for crypto/credential/auth changes
# Trigger: MR with changes to security-sensitive files
# Agent: security-analyst
# Action: Review for common crypto/auth vulnerabilities, post findings as MR comments

name: Security Review
description: >
  Performs an automated security review when merge requests touch cryptographic,
  credential management, or authentication code. Checks for nonce reuse,
  key derivation issues, credential injection, and OWASP top 10 vulnerabilities.

on:
  merge_request:
    events:
      - created
      - updated
    paths:
      - "src-tauri/src/engine/crypto.rs"
      - "src-tauri/src/commands/credentials/**/*.rs"
      - "src-tauri/src/commands/infrastructure/auth.rs"
      - "src-tauri/src/cloud/config.rs"
      - "src-tauri/src/gitlab/config.rs"
      - "src-tauri/src/gitlab/client.rs"

agent: security-analyst

steps:
  - name: Gather diff context
    action: read_merge_request_diff
    params:
      include_full_files: true
      max_context_lines: 50

  - name: Crypto review
    action: analyze
    prompt: |
      You are a security engineer reviewing changes to cryptographic and credential
      management code in a Tauri desktop application. Review the following diff for:

      ## Cryptographic Issues
      1. **Nonce reuse**: Verify nonces are generated with OsRng, never static or reused
      2. **Key derivation**: PBKDF2 iterations must be >= 600,000; check salt uniqueness
      3. **Algorithm choice**: Ensure AES-256-GCM is used correctly (no ECB, no weak ciphers)
      4. **Key storage**: Master keys must go through OS keychain, never hardcoded or logged

      ## Credential Security
      5. **Plaintext exposure**: No credential values in logs, error messages, or UI responses
      6. **Injection**: Token/key values must be parameterized, never string-interpolated into URLs
      7. **Cleanup**: Credentials cleared from memory after use where feasible

      ## Authentication
      8. **Token validation**: PATs and OAuth tokens validated before use
      9. **Scope checks**: API calls use minimum required permissions
      10. **Error handling**: Auth failures don't leak token details

      ## OWASP Considerations
      11. **Input validation**: All external input (tokens, URLs, user data) validated
      12. **Error disclosure**: Error messages don't reveal internal details to users

      For each finding, provide:
      - Severity: critical / high / medium / low / info
      - File and line reference
      - Description of the issue
      - Suggested fix

      Diff:
      {{ steps.gather_diff_context.output }}

  - name: Post findings
    action: comment_on_merge_request
    when: "{{ steps.crypto_review.output.findings | length > 0 }}"
    params:
      comment: |
        ## Security Review Results

        {{ steps.crypto_review.output.summary }}

        {{ for finding in steps.crypto_review.output.findings }}
        ### {{ finding.severity | upper }}: {{ finding.title }}
        **File:** `{{ finding.file }}:{{ finding.line }}`

        {{ finding.description }}

        **Suggested fix:**
        ```
        {{ finding.suggestion }}
        ```
        {{ endfor }}

        ---
        *Auto-generated by GitLab Duo Flow — `security-review.yml`*
      severity_label: "{{ steps.crypto_review.output.max_severity }}"

  - name: Post approval
    action: comment_on_merge_request
    when: "{{ steps.crypto_review.output.findings | length == 0 }}"
    params:
      comment: |
        ## Security Review: Passed

        No security issues found in the crypto/credential/auth changes.
        All checks passed:
        - Nonce randomness
        - Key derivation strength
        - Credential handling
        - Input validation
        - Error disclosure

        ---
        *Auto-generated by GitLab Duo Flow — `security-review.yml`*
