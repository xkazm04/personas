# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Summary

Personas Desktop is a cross-platform desktop app for building, orchestrating, and monitoring AI agent personas. It uses a **Tauri 2** (Rust) backend with a **React 19** (TypeScript) frontend. Data is stored in a local SQLite database with AES-256-GCM encrypted credentials.

## Commands

### Development
```bash
npm install                          # Install frontend dependencies
npm run tauri dev                    # Launch full app (Rust + React) in dev mode
npm run dev                          # Start Vite dev server only (port 1420)
```

On Windows, prefer `.\scripts\desktop-dev.ps1 -Restart` over `npm run tauri dev` — it handles clang PATH, stale processes, and Vite cleanup.

### Build & Quality
```bash
npm run build                        # TypeScript check + Vite production build
npm run lint                         # ESLint on src/
npm run test                         # Vitest (frontend unit tests)
npm run test -- --run                # Vitest single run (CI mode)
vitest run src/path/to/file.test.ts  # Run a single test file
cargo test --manifest-path src-tauri/Cargo.toml                    # Rust tests
cargo clippy --manifest-path src-tauri/Cargo.toml -- -D warnings   # Rust lint
bash scripts/build-review.sh         # Run full pipeline (lint + typecheck + vitest + cargo test + clippy)
```

### TypeScript Bindings
```bash
cargo test --manifest-path src-tauri/Cargo.toml export_bindings    # Regenerate TS types from Rust structs
```
CI checks for binding drift — if you change Rust models with `#[derive(TS)]`, regenerate and commit the updated files in `src/lib/bindings/`.

## Architecture

### Two-Process Model (Tauri IPC)
- **Rust backend** (`src-tauri/src/`): SQLite database, execution engine, encryption, scheduling, cloud client. All business logic runs here.
- **React frontend** (`src/`): UI only. Communicates with Rust exclusively via `invoke()` from `@tauri-apps/api/core`.
- The IPC bridge: Rust functions annotated with `#[tauri::command]` are registered in `src-tauri/src/lib.rs` and called from TypeScript wrappers in `src/api/`.

### Frontend Architecture

**Path alias**: `@/` maps to `src/` (configured in tsconfig.json and vite.config.ts).

**State management**: Single Zustand store (`usePersonaStore`) composed from 15 domain slices in `src/stores/slices/`. Each slice owns its state and actions. The store type is the intersection of all slice interfaces (`PersonaStore` in `src/stores/storeTypes.ts`). Only UI navigation state is persisted to localStorage.

**API layer** (`src/api/`): Thin typed wrappers around `invoke()`. Each file maps 1:1 to a Rust command domain. Types come from auto-generated bindings in `src/lib/bindings/` (generated by `ts-rs` from Rust structs).

**Feature modules** (`src/features/`): Organized by domain — `agents`, `overview`, `pipeline`, `vault`, `triggers`, `templates`, `deployment`, `shared`. Sub-components live in `sub_*` folders (e.g., `sub_editor/`, `sub_canvas/`). Shared reusable components are in `features/shared/components/`.

**Hooks** (`src/hooks/`): Organized into `design/`, `execution/`, `realtime/`, and `utility/` subfolders. Re-exported from `src/hooks/index.ts`.

**Routing**: No client-side router. `PersonasPage` switches content based on `sidebarSection` state in the Zustand store.

### Backend Architecture (Rust)

**Modules** in `src-tauri/src/`:
- `commands/` — Tauri command handlers, organized by domain: `core`, `execution`, `design`, `credentials`, `communication`, `teams`, `tools`, `infrastructure`
- `db/` — SQLite layer: `models/` (row structs), `repos/` (CRUD queries in 4 domain subfolders: `core`, `execution`, `communication`, `resources`), `migrations.rs`, `macros.rs`
- `engine/` — Execution engine: `runner.rs` (agent execution), `scheduler.rs` (cron), `crypto.rs` (AES-GCM), `bus.rs` (event bus), `healing.rs` (self-healing), `queue.rs`, `background.rs`
- `cloud/` — Cloud orchestrator HTTP client
- `error.rs` — Unified `AppError` type using `thiserror`

**AppState** (`lib.rs`): Shared state managed by Tauri, containing the DB pool, execution engine, scheduler, auth state, and cloud client. Accessed in commands via `tauri::State<Arc<AppState>>`.

**Database**: SQLite with r2d2 connection pool (max 8 connections), WAL mode, foreign keys enabled. Migrations run at startup. Test databases use temp files via `init_test_db()`.

### Styling
Tailwind CSS 4 via `@tailwindcss/vite` plugin. Design tokens in `src/lib/utils/designTokens.ts`. Global styles in `src/styles/globals.css`.

### Testing
- Frontend: Vitest + jsdom + React Testing Library. Setup in `src/test/setup.ts` which mocks `@tauri-apps/api/core` (invoke) and `@tauri-apps/api/event` (listen/emit). Tests colocated in `__tests__/` folders.
- Backend: Standard `cargo test`. Use `db::init_test_db()` for tests needing a database.

### Environment
`.env` holds optional Supabase config for Google OAuth. The anon key is a public client key (not a secret). Values are read at compile time via `option_env!()` for production builds.

## TypeScript Conventions
- Strict mode with `noUnusedLocals`, `noUnusedParameters`, `noUncheckedIndexedAccess`
- Unused function params prefixed with `_` (ESLint rule: `argsIgnorePattern: "^_"`)
- Target ES2021
