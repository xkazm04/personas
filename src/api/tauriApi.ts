/**
 * Tauri IPC API — typed invoke() wrappers for all Rust commands.
 * Replaces the old personaApi.ts fetch-based client.
 *
 * Every function maps 1:1 to a #[tauri::command] in src-tauri/src/commands/.
 * Types are auto-generated by ts-rs from Rust structs.
 */
import { invoke } from "@tauri-apps/api/core";

import type { Persona } from "@/lib/bindings/Persona";
import type { CreatePersonaInput } from "@/lib/bindings/CreatePersonaInput";
import type { UpdatePersonaInput } from "@/lib/bindings/UpdatePersonaInput";
import type { PersonaToolDefinition } from "@/lib/bindings/PersonaToolDefinition";
import type { CreateToolDefinitionInput } from "@/lib/bindings/CreateToolDefinitionInput";
import type { UpdateToolDefinitionInput } from "@/lib/bindings/UpdateToolDefinitionInput";
import type { PersonaTool } from "@/lib/bindings/PersonaTool";
import type { PersonaTrigger } from "@/lib/bindings/PersonaTrigger";
import type { CreateTriggerInput } from "@/lib/bindings/CreateTriggerInput";
import type { UpdateTriggerInput } from "@/lib/bindings/UpdateTriggerInput";
import type { PersonaExecution } from "@/lib/bindings/PersonaExecution";
import type { PersonaCredential } from "@/lib/bindings/PersonaCredential";
import type { CreateCredentialInput } from "@/lib/bindings/CreateCredentialInput";
import type { UpdateCredentialInput } from "@/lib/bindings/UpdateCredentialInput";
import type { CredentialEvent } from "@/lib/bindings/CredentialEvent";
import type { CreateCredentialEventInput } from "@/lib/bindings/CreateCredentialEventInput";
import type { UpdateCredentialEventInput } from "@/lib/bindings/UpdateCredentialEventInput";
import type { PersonaEvent } from "@/lib/bindings/PersonaEvent";
import type { CreatePersonaEventInput } from "@/lib/bindings/CreatePersonaEventInput";
import type { PersonaEventSubscription } from "@/lib/bindings/PersonaEventSubscription";
import type { CreateEventSubscriptionInput } from "@/lib/bindings/CreateEventSubscriptionInput";
import type { UpdateEventSubscriptionInput } from "@/lib/bindings/UpdateEventSubscriptionInput";
import type { PersonaMessage } from "@/lib/bindings/PersonaMessage";
import type { PersonaMessageDelivery } from "@/lib/bindings/PersonaMessageDelivery";
import type { PersonaGroup } from "@/lib/bindings/PersonaGroup";
import type { CreatePersonaGroupInput } from "@/lib/bindings/CreatePersonaGroupInput";
import type { UpdatePersonaGroupInput } from "@/lib/bindings/UpdatePersonaGroupInput";
import type { PersonaMemory } from "@/lib/bindings/PersonaMemory";
import type { CreatePersonaMemoryInput } from "@/lib/bindings/CreatePersonaMemoryInput";
import type { PersonaHealingIssue } from "@/lib/bindings/PersonaHealingIssue";
import type { PersonaTeam } from "@/lib/bindings/PersonaTeam";
import type { CreateTeamInput } from "@/lib/bindings/CreateTeamInput";
import type { UpdateTeamInput } from "@/lib/bindings/UpdateTeamInput";
import type { PersonaTeamMember } from "@/lib/bindings/PersonaTeamMember";
import type { PersonaTeamConnection } from "@/lib/bindings/PersonaTeamConnection";
import type { ConnectorDefinition } from "@/lib/bindings/ConnectorDefinition";
import type { CreateConnectorDefinitionInput } from "@/lib/bindings/CreateConnectorDefinitionInput";
import type { UpdateConnectorDefinitionInput } from "@/lib/bindings/UpdateConnectorDefinitionInput";
import type { PersonaDesignReview } from "@/lib/bindings/PersonaDesignReview";
import type { PersonaManualReview } from "@/lib/bindings/PersonaManualReview";
import type { PersonaMetricsSnapshot } from "@/lib/bindings/PersonaMetricsSnapshot";
import type { MetricsSummary } from "@/lib/bindings/MetricsSummary";
import type { PersonaPromptVersion } from "@/lib/bindings/PersonaPromptVersion";

// ============================================================================
// Personas
// ============================================================================

export const listPersonas = () =>
  invoke<Persona[]>("list_personas");

export const getPersona = (id: string) =>
  invoke<Persona>("get_persona", { id });

export const createPersona = (input: CreatePersonaInput) =>
  invoke<Persona>("create_persona", { input });

export const updatePersona = (id: string, input: UpdatePersonaInput) =>
  invoke<Persona>("update_persona", { id, input });

export const deletePersona = (id: string) =>
  invoke<boolean>("delete_persona", { id });

// ============================================================================
// Tool Definitions & Assignments
// ============================================================================

export const listToolDefinitions = () =>
  invoke<PersonaToolDefinition[]>("list_tool_definitions");

export const getToolDefinition = (id: string) =>
  invoke<PersonaToolDefinition>("get_tool_definition", { id });

export const getToolDefinitionsByCategory = (category: string) =>
  invoke<PersonaToolDefinition[]>("get_tool_definitions_by_category", { category });

export const createToolDefinition = (input: CreateToolDefinitionInput) =>
  invoke<PersonaToolDefinition>("create_tool_definition", { input });

export const updateToolDefinition = (id: string, input: UpdateToolDefinitionInput) =>
  invoke<PersonaToolDefinition>("update_tool_definition", { id, input });

export const deleteToolDefinition = (id: string) =>
  invoke<boolean>("delete_tool_definition", { id });

export const assignTool = (
  personaId: string,
  toolId: string,
  toolConfig?: string,
) =>
  invoke<PersonaTool>("assign_tool", {
    personaId,
    toolId,
    toolConfig: toolConfig ?? null,
  });

export const unassignTool = (personaId: string, toolId: string) =>
  invoke<boolean>("unassign_tool", { personaId, toolId });

// ── Tool Usage Analytics ──────────────────────────────────────────────────
import type { ToolUsageSummary, ToolUsageOverTime, PersonaUsageSummary } from "@/lib/types/types";

export const getToolUsageSummary = (since: string, personaId?: string) =>
  invoke<ToolUsageSummary[]>("get_tool_usage_summary", { since, personaId: personaId ?? null });

export const getToolUsageOverTime = (since: string, personaId?: string) =>
  invoke<ToolUsageOverTime[]>("get_tool_usage_over_time", { since, personaId: personaId ?? null });

export const getToolUsageByPersona = (since: string) =>
  invoke<PersonaUsageSummary[]>("get_tool_usage_by_persona", { since });

// ============================================================================
// Triggers
// ============================================================================

export const listAllTriggers = () =>
  invoke<PersonaTrigger[]>("list_all_triggers");

export const listTriggers = (personaId: string) =>
  invoke<PersonaTrigger[]>("list_triggers", { personaId });

export const createTrigger = (input: CreateTriggerInput) =>
  invoke<PersonaTrigger>("create_trigger", { input });

export const updateTrigger = (id: string, input: UpdateTriggerInput) =>
  invoke<PersonaTrigger>("update_trigger", { id, input });

export const deleteTrigger = (id: string) =>
  invoke<boolean>("delete_trigger", { id });

// ============================================================================
// Executions
// ============================================================================

export const listExecutions = (personaId: string, limit?: number) =>
  invoke<PersonaExecution[]>("list_executions", {
    personaId,
    limit: limit ?? null,
  });

export const getExecution = (id: string) =>
  invoke<PersonaExecution>("get_execution", { id });

export const createExecution = (
  personaId: string,
  triggerId?: string,
  inputData?: string,
  modelUsed?: string,
) =>
  invoke<PersonaExecution>("create_execution", {
    personaId,
    triggerId: triggerId ?? null,
    inputData: inputData ?? null,
    modelUsed: modelUsed ?? null,
  });

export const cancelExecution = (id: string) =>
  invoke<void>("cancel_execution", { id });

export const executePersona = (
  personaId: string,
  triggerId?: string,
  inputData?: string,
) =>
  invoke<PersonaExecution>("execute_persona", {
    personaId,
    triggerId: triggerId ?? null,
    inputData: inputData ?? null,
  });

export const getExecutionLog = (id: string) =>
  invoke<string | null>("get_execution_log", { id });

// ============================================================================
// Credentials
// ============================================================================

export const listCredentials = () =>
  invoke<PersonaCredential[]>("list_credentials");

export const createCredential = (input: CreateCredentialInput) =>
  invoke<PersonaCredential>("create_credential", { input });

export const updateCredential = (id: string, input: UpdateCredentialInput) =>
  invoke<PersonaCredential>("update_credential", { id, input });

export const deleteCredential = (id: string) =>
  invoke<boolean>("delete_credential", { id });

export const listCredentialEvents = (credentialId: string) =>
  invoke<CredentialEvent[]>("list_credential_events", { credentialId });

export const createCredentialEvent = (input: CreateCredentialEventInput) =>
  invoke<CredentialEvent>("create_credential_event", { input });

export const updateCredentialEvent = (id: string, input: UpdateCredentialEventInput) =>
  invoke<CredentialEvent>("update_credential_event", { id, input });

// ── Credential Security ─────────────────────────────────────────────────

export interface HealthcheckResult {
  success: boolean;
  message: string;
}

export interface VaultStatus {
  key_source: string;
  total: number;
  encrypted: number;
  plaintext: number;
}

export const healthcheckCredential = (credentialId: string) =>
  invoke<HealthcheckResult>("healthcheck_credential", { credentialId });

export const vaultStatus = () =>
  invoke<VaultStatus>("vault_status");

// ============================================================================
// Events
// ============================================================================

export const listEvents = (limit?: number, projectId?: string) =>
  invoke<PersonaEvent[]>("list_events", {
    limit: limit ?? null,
    projectId: projectId ?? null,
  });

export const publishEvent = (input: CreatePersonaEventInput) =>
  invoke<PersonaEvent>("publish_event", { input });

export const listSubscriptions = (personaId: string) =>
  invoke<PersonaEventSubscription[]>("list_subscriptions", { personaId });

export const createSubscription = (input: CreateEventSubscriptionInput) =>
  invoke<PersonaEventSubscription>("create_subscription", { input });

export const updateSubscription = (
  id: string,
  input: UpdateEventSubscriptionInput,
) => invoke<PersonaEventSubscription>("update_subscription", { id, input });

export const deleteSubscription = (id: string) =>
  invoke<boolean>("delete_subscription", { id });

export const testEventFlow = (eventType: string, payload?: string) =>
  invoke<PersonaEvent>("test_event_flow", {
    eventType,
    payload: payload ?? null,
  });

// ============================================================================
// Messages
// ============================================================================

export const listMessages = (limit?: number, offset?: number) =>
  invoke<PersonaMessage[]>("list_messages", {
    limit: limit ?? null,
    offset: offset ?? null,
  });

export const getMessage = (id: string) =>
  invoke<PersonaMessage>("get_message", { id });

export const markMessageRead = (id: string) =>
  invoke<void>("mark_message_read", { id });

export const markAllMessagesRead = (personaId?: string) =>
  invoke<void>("mark_all_messages_read", {
    personaId: personaId ?? null,
  });

export const deleteMessage = (id: string) =>
  invoke<boolean>("delete_message", { id });

export const getUnreadMessageCount = () =>
  invoke<number>("get_unread_message_count", {});

export const getMessageCount = () =>
  invoke<number>("get_message_count", {});

export const getMessageDeliveries = (messageId: string) =>
  invoke<PersonaMessageDelivery[]>("get_message_deliveries", { messageId });

// ============================================================================
// Design
// ============================================================================

export interface DesignStartResult {
  design_id: string;
}

export interface FeasibilityResult {
  confirmed_capabilities: string[];
  issues: string[];
  overall: string;
}

export const startDesignAnalysis = (instruction: string, personaId: string) =>
  invoke<DesignStartResult>("start_design_analysis", { instruction, personaId });

export const refineDesign = (personaId: string, feedback: string) =>
  invoke<DesignStartResult>("refine_design", { personaId, feedback });

export const testDesignFeasibility = (designResult: string) =>
  invoke<FeasibilityResult>("test_design_feasibility", { designResult });

export const cancelDesignAnalysis = () =>
  invoke<void>("cancel_design_analysis");

// ============================================================================
// Design Reviews
// ============================================================================

export const listDesignReviews = (testRunId?: string, limit?: number) =>
  invoke<PersonaDesignReview[]>("list_design_reviews", {
    testRunId: testRunId ?? null,
    limit: limit ?? null,
  });

export const getDesignReview = (id: string) =>
  invoke<PersonaDesignReview>("get_design_review", { id });

export const deleteDesignReview = (id: string) =>
  invoke<boolean>("delete_design_review", { id });

export const startDesignReviewRun = (personaId: string, testCases: object[]) =>
  invoke<{ run_id: string; total: number }>("start_design_review_run", {
    personaId,
    testCases,
  });

// ============================================================================
// Manual Reviews
// ============================================================================

export const listManualReviews = (personaId?: string, status?: string) =>
  invoke<PersonaManualReview[]>("list_manual_reviews", {
    personaId: personaId ?? null,
    status: status ?? null,
  });

export const updateManualReviewStatus = (
  id: string,
  status: string,
  reviewerNotes?: string,
) =>
  invoke<PersonaManualReview>("update_manual_review_status", {
    id,
    status,
    reviewerNotes: reviewerNotes ?? null,
  });

export const getPendingReviewCount = (personaId?: string) =>
  invoke<number>("get_pending_review_count", {
    personaId: personaId ?? null,
  });

// ============================================================================
// Observability
// ============================================================================

export const getMetricsSummary = (days?: number) =>
  invoke<MetricsSummary>("get_metrics_summary", {
    days: days ?? null,
  });

export const getMetricsSnapshots = (
  personaId?: string,
  startDate?: string,
  endDate?: string,
) =>
  invoke<PersonaMetricsSnapshot[]>("get_metrics_snapshots", {
    personaId: personaId ?? null,
    startDate: startDate ?? null,
    endDate: endDate ?? null,
  });

export const getPromptVersions = (personaId: string, limit?: number) =>
  invoke<PersonaPromptVersion[]>("get_prompt_versions", {
    personaId,
    limit: limit ?? null,
  });

export const getAllMonthlySpend = () =>
  invoke<Array<[string, number]>>("get_all_monthly_spend");

// ============================================================================
// Groups
// ============================================================================

export const listGroups = () =>
  invoke<PersonaGroup[]>("list_groups");

export const createGroup = (input: CreatePersonaGroupInput) =>
  invoke<PersonaGroup>("create_group", { input });

export const updateGroup = (id: string, input: UpdatePersonaGroupInput) =>
  invoke<PersonaGroup>("update_group", { id, input });

export const deleteGroup = (id: string) =>
  invoke<boolean>("delete_group", { id });

export const reorderGroups = (orderedIds: string[]) =>
  invoke<void>("reorder_groups", { orderedIds });

// ============================================================================
// Memories
// ============================================================================

export const listMemories = (
  personaId?: string,
  category?: string,
  limit?: number,
  offset?: number,
) =>
  invoke<PersonaMemory[]>("list_memories", {
    personaId: personaId ?? null,
    category: category ?? null,
    limit: limit ?? null,
    offset: offset ?? null,
  });

export const createMemory = (input: CreatePersonaMemoryInput) =>
  invoke<PersonaMemory>("create_memory", { input });

export const deleteMemory = (id: string) =>
  invoke<boolean>("delete_memory", { id });

// ============================================================================
// Healing
// ============================================================================

export const listHealingIssues = (personaId?: string, status?: string) =>
  invoke<PersonaHealingIssue[]>("list_healing_issues", {
    personaId: personaId ?? null,
    status: status ?? null,
  });

export const getHealingIssue = (id: string) =>
  invoke<PersonaHealingIssue>("get_healing_issue", { id });

export const updateHealingStatus = (id: string, status: string) =>
  invoke<void>("update_healing_status", { id, status });

export interface HealingAnalysisResult {
  status: string;
  failures_analyzed: number;
  issues_created: number;
  auto_fixed: number;
}

export const runHealingAnalysis = (personaId: string) =>
  invoke<HealingAnalysisResult>("run_healing_analysis", { personaId });

// ============================================================================
// Teams
// ============================================================================

export const listTeams = () =>
  invoke<PersonaTeam[]>("list_teams");

export const getTeam = (id: string) =>
  invoke<PersonaTeam>("get_team", { id });

export const createTeam = (input: CreateTeamInput) =>
  invoke<PersonaTeam>("create_team", { input });

export const updateTeam = (id: string, input: UpdateTeamInput) =>
  invoke<PersonaTeam>("update_team", { id, input });

export const deleteTeam = (id: string) =>
  invoke<boolean>("delete_team", { id });

export const listTeamMembers = (teamId: string) =>
  invoke<PersonaTeamMember[]>("list_team_members", { teamId });

export const addTeamMember = (
  teamId: string,
  personaId: string,
  role?: string,
  positionX?: number,
  positionY?: number,
  config?: string,
) =>
  invoke<PersonaTeamMember>("add_team_member", {
    teamId,
    personaId,
    role: role ?? null,
    positionX: positionX ?? null,
    positionY: positionY ?? null,
    config: config ?? null,
  });

export const updateTeamMember = (
  id: string,
  role?: string,
  positionX?: number,
  positionY?: number,
  config?: string,
) =>
  invoke<void>("update_team_member", {
    id,
    role: role ?? null,
    positionX: positionX ?? null,
    positionY: positionY ?? null,
    config: config ?? null,
  });

export const removeTeamMember = (id: string) =>
  invoke<boolean>("remove_team_member", { id });

export const listTeamConnections = (teamId: string) =>
  invoke<PersonaTeamConnection[]>("list_team_connections", { teamId });

export const createTeamConnection = (
  teamId: string,
  sourceMemberId: string,
  targetMemberId: string,
  connectionType?: string,
  condition?: string,
  label?: string,
) =>
  invoke<PersonaTeamConnection>("create_team_connection", {
    teamId,
    sourceMemberId,
    targetMemberId,
    connectionType: connectionType ?? null,
    condition: condition ?? null,
    label: label ?? null,
  });

export const deleteTeamConnection = (id: string) =>
  invoke<boolean>("delete_team_connection", { id });

// ── Pipeline ─────────────────────────────────────────────────────────────

export interface PipelineRun {
  id: string;
  team_id: string;
  status: string;
  node_statuses: string;
  input_data: string | null;
  started_at: string;
  completed_at: string | null;
  error_message: string | null;
}

export const executeTeam = (teamId: string, inputData?: string) =>
  invoke<string>("execute_team", { teamId, inputData: inputData ?? null });

export const listPipelineRuns = (teamId: string) =>
  invoke<PipelineRun[]>("list_pipeline_runs", { teamId });

export const getPipelineRun = (id: string) =>
  invoke<PipelineRun>("get_pipeline_run", { id });

// ============================================================================
// Connectors
// ============================================================================

export const listConnectors = () =>
  invoke<ConnectorDefinition[]>("list_connectors");

export const getConnector = (id: string) =>
  invoke<ConnectorDefinition>("get_connector", { id });

export const createConnector = (input: CreateConnectorDefinitionInput) =>
  invoke<ConnectorDefinition>("create_connector", { input });

export const updateConnector = (
  id: string,
  input: UpdateConnectorDefinitionInput,
) => invoke<ConnectorDefinition>("update_connector", { id, input });

export const deleteConnector = (id: string) =>
  invoke<boolean>("delete_connector", { id });

// ============================================================================
// Scheduler
// ============================================================================

export interface SchedulerStats {
  running: boolean;
  events_processed: number;
  events_delivered: number;
  events_failed: number;
  triggers_fired: number;
}

export const getSchedulerStatus = () =>
  invoke<SchedulerStats>("get_scheduler_status");

export const startScheduler = () =>
  invoke<SchedulerStats>("start_scheduler");

export const stopScheduler = () =>
  invoke<SchedulerStats>("stop_scheduler");

// ============================================================================
// Auth
// ============================================================================

export interface AuthStateResponse {
  is_authenticated: boolean;
  is_offline: boolean;
  user: {
    id: string;
    email: string;
    display_name: string | null;
    avatar_url: string | null;
  } | null;
  subscription: {
    plan: string;
    status: string;
    current_period_end: string | null;
  } | null;
}

export const loginWithGoogle = () =>
  invoke<void>("login_with_google");

export const getAuthState = () =>
  invoke<AuthStateResponse>("get_auth_state");

export const logoutUser = () =>
  invoke<void>("logout");

export const refreshSession = () =>
  invoke<AuthStateResponse>("refresh_session");

// ============================================================================
// System
// ============================================================================

export interface HealthCheckItem {
  id: string;
  label: string;
  status: string;
  detail: string | null;
}

export interface SystemHealthReport {
  checks: HealthCheckItem[];
  all_ok: boolean;
}

export const systemHealthCheck = () =>
  invoke<SystemHealthReport>("system_health_check");

// ============================================================================
// Import/Export
// ============================================================================

export const exportPersona = (personaId: string) =>
  invoke<boolean>("export_persona", { personaId });

export const importPersona = () =>
  invoke<string | null>("import_persona");

// ============================================================================
// Cloud
// ============================================================================

export interface CloudConfig {
  url: string;
  is_connected: boolean;
}

export interface CloudWorkerCounts {
  idle: number;
  executing: number;
  disconnected: number;
}

export interface CloudOAuthState {
  connected: boolean;
  scopes: string[] | null;
  expiresAt: string | null;
}

export interface CloudStatusResult {
  workerCounts: CloudWorkerCounts;
  queueLength: number;
  activeExecutions: number;
  hasClaudeToken: boolean;
  oauth: CloudOAuthState | null;
}

export interface OAuthAuthorizeResult {
  authUrl: string;
  state: string;
  instructions: string | null;
}

export interface OAuthStatusResult {
  connected: boolean;
  scopes: string[] | null;
  expiresAt: string | null;
  isExpired: boolean | null;
}

// Config
export const cloudConnect = (url: string, apiKey: string) =>
  invoke<void>("cloud_connect", { url, apiKey });

export const cloudDisconnect = () =>
  invoke<void>("cloud_disconnect");

export const cloudGetConfig = () =>
  invoke<CloudConfig | null>("cloud_get_config");

// Status
export const cloudStatus = () =>
  invoke<CloudStatusResult>("cloud_status");

// Execution
export const cloudExecutePersona = (personaId: string, inputData?: string) =>
  invoke<string>("cloud_execute_persona", { personaId, inputData });

export const cloudCancelExecution = (executionId: string) =>
  invoke<boolean>("cloud_cancel_execution", { executionId });

// OAuth
export const cloudOAuthAuthorize = () =>
  invoke<OAuthAuthorizeResult>("cloud_oauth_authorize");

export const cloudOAuthCallback = (code: string, oauthState: string) =>
  invoke<unknown>("cloud_oauth_callback", { code, oauthState });

export const cloudOAuthStatus = () =>
  invoke<OAuthStatusResult>("cloud_oauth_status");

export const cloudOAuthRefresh = () =>
  invoke<unknown>("cloud_oauth_refresh");

export const cloudOAuthDisconnect = () =>
  invoke<void>("cloud_oauth_disconnect");
